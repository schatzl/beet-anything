<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beet Anything - Crop Rotation & Companion Planting</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Smart garden planning with crop rotation and companion planting">
    <meta name="theme-color" content="#4a7c59">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Beet Anything">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkJlZXQgQW55dGhpbmciLAogICJzaG9ydF9uYW1lIjogIkJlZXQgQW55dGhpbmciLAogICJkZXNjcmlwdGlvbiI6ICJTbWFydCBnYXJkZW4gcGxhbm5pbmcgd2l0aCBjcm9wIHJvdGF0aW9uIGFuZCBjb21wYW5pb24gcGxhbnRpbmciLAogICJzdGFydF91cmwiOiAiLi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmNGYxZWEiLAogICJ0aGVtZV9jb2xvciI6ICIjNGE3YzU5IiwKICAib3JpZW50YXRpb24iOiAiYW55IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3JlY3Qgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIGZpbGw9JyUyMzRhN2M1OScvJTNFJTNDdGV4dCB4PSc1MCUyNScgeT0nNTAlMjUnIGZvbnQtc2l6ZT0nNTAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGRvbWluYW50LWJhc2VsaW5lPSdtaWRkbGUnJTNFJUYwJTlGJThDJUIxJTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnJTNFJTNDcmVjdCB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgZmlsbD0nJTIzNGE3YzU5Jy8lM0UlM0N0ZXh0IHg9JzUwJTI1JyB5PSc1MCUyNScgZm9udC1zaXplPSc1MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZG9taW5hbnQtYmFzZWxpbmU9J21pZGRsZSclM0UlRjAlOUYlOEMlQjElM0MvdGV4dCUzRSUzQy9zdmclM0UiLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiLAogICAgICAicHVycG9zZSI6ICJhbnkgbWFza2FibGUiCiAgICB9CiAgXQp9">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%234a7c59'/%3E%3Ctext x='50%25' y='50%25' font-size='50' text-anchor='middle' dominant-baseline='middle'%3Eüå±%3C/text%3E%3C/svg%3E">
    
    <style>
        /* Inter Font from rsms.me */
        @import url('https://rsms.me/inter/inter.css');
        
        /* Inter Variable Font Support */
        @supports (font-variation-settings: normal) {
            body {
                font-family: 'Inter var', sans-serif;
            }
        }
        
        :root {
            --soil-dark: #3a2f28;
            --soil-medium: #5d4e3f;
            --leaf-green: #4a7c59;
            --sage: #8ba888;
            --cream: #f4f1ea;
            --terracotta: #c1694f;
            --sun-yellow: #e8b84d;
            --root-brown: #6b4423;
            --water-blue: #7ba8a8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            font-feature-settings: 'liga' 1, 'calt' 1;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: var(--cream);
            color: var(--soil-dark);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(138, 168, 136, 0.03), transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(193, 105, 79, 0.02), transparent 40%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }
        
        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 3.5rem 0 2rem 0;
            position: relative;
        }
        
        h1 {
            font-family: 'Inter', sans-serif;
            font-size: 3.5rem;
            color: var(--leaf-green);
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
            animation: slideDown 0.8s ease-out;
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: var(--soil-medium);
            font-weight: 300;
            font-style: italic;
            animation: fadeIn 1s ease-out 0.3s both;
        }
        
        .data-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .language-switch {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            background: white;
            border-radius: 20px;
            padding: 0.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .language-switch button {
            border: none;
            background: transparent;
            padding: 0.5rem 1rem;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            color: var(--soil-medium);
        }
        
        .language-switch button.active {
            background: var(--leaf-green);
            color: white;
        }
        
        .language-switch button:hover:not(.active) {
            background: var(--cream);
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            animation: fadeIn 1s ease-out 0.5s both;
        }
        
        .panel {
            background: var(--cream);
            border-radius: 0;
            padding: 2rem;
            border: none;
        }
        
        .panel h2 {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            color: var(--leaf-green);
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--sage);
            padding-bottom: 0.5rem;
        }
        
        .year-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: linear-gradient(135deg, var(--sage) 0%, var(--leaf-green) 100%);
            border-radius: 8px;
            color: white;
        }
        
        .year-selector button {
            background: white;
            color: var(--leaf-green);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .year-selector button:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .year-display {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            flex: 1;
            text-align: center;
        }
        
        .wishlist-section {
            margin-bottom: 2rem;
        }
        
        .wishlist-input {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        select, input, button {
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
        }
        
        select, input[type="text"], input[type="number"] {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid var(--sage);
            border-radius: 6px;
            background: var(--cream);
            color: var(--soil-dark);
            transition: all 0.3s ease;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--leaf-green);
            background: white;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: var(--leaf-green);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--soil-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 124, 89, 0.3);
        }
        
        .btn-secondary {
            background: var(--terracotta);
            color: white;
        }
        
        .btn-secondary:hover {
            background: var(--root-brown);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(193, 105, 79, 0.3);
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }
        
        .btn-suggest {
            width: 100%;
            background: linear-gradient(135deg, var(--sun-yellow) 0%, var(--terracotta) 100%);
            color: var(--soil-dark);
            font-size: 1.1rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .btn-suggest:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(232, 184, 77, 0.4);
        }
        
        .wishlist-items {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .wishlist-tag {
            background: var(--sage);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            animation: popIn 0.3s ease-out;
        }
        
        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .wishlist-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .wishlist-tag button:hover {
            transform: scale(1.2);
        }
        
        .garden-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .bed {
            background: linear-gradient(135deg, #f8f5ee 0%, #ebe6da 100%);
            border: 3px solid var(--soil-medium);
            border-radius: 10px;
            padding: 1.5rem;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .bed:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(58, 47, 40, 0.15);
        }
        
        .bed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--sage);
        }
        
        .bed-name {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--leaf-green);
        }
        
        .bed-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .bed-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
            transition: transform 0.2s ease;
        }
        
        .bed-actions button:hover {
            transform: scale(1.2);
        }
        
        .bed-content {
            min-height: 100px;
        }
        
        .plant-assignment {
            background: white;
            border-left: 4px solid var(--leaf-green);
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .plant-assignment:hover {
            background: var(--cream);
            border-left-width: 6px;
        }
        
        .plant-name {
            font-weight: 700;
            color: var(--leaf-green);
            margin-bottom: 0.25rem;
        }
        
        .plant-meta {
            font-size: 0.85rem;
            color: var(--soil-medium);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .pest-icons {
            display: flex;
            gap: 0.35rem;
            margin-top: 0.5rem;
            padding: 0.25rem 0;
        }
        
        .pest-icon {
            font-size: 1.1rem;
            cursor: help;
            opacity: 0.8;
            transition: opacity 0.2s ease, transform 0.2s ease;
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }
        
        .pest-icon:hover {
            opacity: 1;
            transform: scale(1.15);
        }
        
        /* Touch-friendly tooltip */
        .pest-icon.show-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 0.5rem;
            pointer-events: none;
            max-width: 300px;
            white-space: normal;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .pest-icon.show-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            margin-bottom: -6px;
            z-index: 1000;
            pointer-events: none;
        }
        
        /* Also style companion tags for touch */
        .companion-tag {
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }
        
        .companion-tag.show-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 0.5rem;
            pointer-events: none;
            max-width: 300px;
            white-space: normal;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .companion-tag.show-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            margin-bottom: -6px;
            z-index: 1000;
            pointer-events: none;
        }
        
        .nutrition-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.15rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1;
        }
        
        .nutrition-high {
            background: var(--terracotta);
            color: white;
        }
        
        .nutrition-medium {
            background: var(--sun-yellow);
            color: var(--soil-dark);
        }
        
        .nutrition-low {
            background: var(--sage);
            color: white;
        }
        
        .empty-bed {
            color: var(--soil-medium);
            font-style: italic;
            text-align: center;
            padding: 2rem 0;
            cursor: pointer;
        }
        
        /* Tab Navigation */
        .tab-container {
            background: var(--cream);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(58, 47, 40, 0.08);
            border: 2px solid rgba(74, 124, 89, 0.2);
            overflow: hidden;
            transform: translateZ(0);
            will-change: auto;
        }
        
        .tab-nav {
            display: flex;
            gap: 0;
            margin-bottom: 0;
            padding-bottom: 0;
            background: rgba(0, 0, 0, 0.03);
            padding: 0;
        }
        
        .tab-nav::-webkit-scrollbar {
            height: 3px;
        }
        
        .tab-nav::-webkit-scrollbar-thumb {
            background: var(--sage);
            border-radius: 3px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            background: rgba(0, 0, 0, 0.03);
            color: var(--soil-medium);
            border: none;
            border-top: 4px solid transparent;
            border-radius: 0;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .tab-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .tab-btn.active {
            background: var(--cream);
            color: var(--soil-dark);
            font-weight: 600;
            border-top: 4px solid var(--leaf-green);
            border-radius: 8px 8px 0 0;
            padding-top: calc(0.75rem - 4px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Easy Layout Styles */
        .plant-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .plant-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: white;
            border: 2px solid var(--sage);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .plant-checkbox:hover {
            border-color: var(--leaf-green);
            background: var(--cream);
        }
        
        .plant-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .plant-checkbox.checked {
            border-color: var(--leaf-green);
            background: var(--leaf-light);
        }
        
        .mode-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .mode-option {
            flex: 1;
            padding: 1rem;
            border: 2px solid var(--sage);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .mode-option:hover {
            border-color: var(--leaf-green);
        }
        
        .mode-option.selected {
            border-color: var(--leaf-green);
            background: var(--leaf-light);
        }
        
        .mode-option input[type="radio"] {
            margin-right: 0.5rem;
        }
        
        .optimization-result {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--cream);
            border-radius: 8px;
            border-left: 4px solid var(--leaf-green);
        }
        
        .result-score {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--leaf-green);
            margin-bottom: 1rem;
        }
        
        .proposed-bed {
            background: white;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            border-left: 4px solid var(--sage);
        }
        
        .bed-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .bed-comparison-arrow {
            font-size: 1.5rem;
            color: var(--leaf-green);
        }
        
        .bed-reasons {
            font-size: 0.85rem;
            color: var(--soil-medium);
            margin-top: 0.5rem;
            padding-left: 1rem;
        }
        
        .bed-reasons li {
            margin-bottom: 0.25rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(58, 47, 40, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--sage);
        }
        
        .modal-header h3 {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            color: var(--leaf-green);
            font-size: 1.8rem;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--soil-medium);
            line-height: 1;
        }
        
        .close-btn:hover {
            color: var(--terracotta);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--soil-dark);
        }
        
        .companions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .companion-tag {
            padding: 0.4rem 0.8rem;
            border-radius: 16px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .companion-good {
            background: #d4edda;
            color: #155724;
        }
        
        .companion-bad {
            background: #f8d7da;
            color: #721c24;
        }
        
        .companion-protection {
            background: linear-gradient(135deg, #7ba8a8 0%, #5d8a8a 100%);
            color: white;
            font-weight: 600;
        }
        
        .companion-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }
        
        /* Legend Box */
        .legend-box {
            background: linear-gradient(135deg, #f0f7f4 0%, #e8f4f0 100%);
            border: 2px solid var(--sage);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        
        .legend-box summary {
            cursor: pointer;
            user-select: none;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background 0.2s ease;
        }
        
        .legend-box summary:hover {
            background: rgba(74, 124, 89, 0.1);
        }
        
        .legend-box details[open] summary {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--sage);
        }
        
        .legend-content {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
        }
        
        .legend-item .companion-tag {
            flex-shrink: 0;
            min-width: fit-content;
        }
        
        .legend-item span:last-child {
            color: var(--soil-medium);
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .legend-item.legend-info {
            background: transparent;
            padding: 0.75rem 0.5rem 0.25rem 0.5rem;
            border-top: 1px dashed var(--sage);
            margin-top: 0.5rem;
            justify-content: center;
        }
        
        /* Tooltips */
        [title] {
            cursor: help;
            position: relative;
        }
        
        .companion-tag[title]:hover {
            filter: brightness(0.95);
        }
        
        @media (max-width: 480px) {
            .legend-box {
                font-size: 0.85rem;
                padding: 0.75rem;
            }
            
            .legend-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            /* Tabs & Optimizer mobile */
            .tab-btn {
                font-size: 0.75rem;
                padding: 0.5rem 0.7rem;
                border-top-width: 3px;
            }
            
            .plant-selector {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .plant-checkbox {
                padding: 0.35rem 0.25rem;
                font-size: 0.75rem;
            }
            
            .optimization-result {
                padding: 1rem;
            }
            
            .result-score {
                font-size: 1.1rem;
            }
            
            .proposed-bed {
                font-size: 0.8rem;
            }
            
            .wishlist-input {
                flex-direction: column;
            }
            
            /* Buttons volle Breite */
            .btn {
                width: 100%;
                white-space: normal;
                min-height: 44px;
            }
            
            /* Tabs scrollbar schmaler */
            .tab-nav {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }
            
            /* Panel ohne overflow */
            .panel {
                overflow-x: hidden;
            }
            
            /* Inputs volle Breite */
            input[type="text"],
            select {
                max-width: 100%;
                box-sizing: border-box;
            }
        }
        
        .suggestion-box {
            background: linear-gradient(135deg, #fff8e1 0%, #ffe7b8 100%);
            border: 2px solid var(--sun-yellow);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .suggestion-box h4 {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            color: var(--root-brown);
            margin-bottom: 1rem;
        }
        
        .suggestion-item {
            background: white;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 6px;
            border-left: 4px solid var(--sun-yellow);
        }
        
        .suggestion-item strong {
            color: var(--leaf-green);
        }
        
        .info-text {
            background: var(--cream);
            padding: 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            color: var(--soil-medium);
            margin-bottom: 1rem;
            border-left: 3px solid var(--water-blue);
        }
        
        .compatibility-matrix {
            overflow-x: auto;
            margin-top: 1rem;
        }
        
        .compatibility-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .compatibility-table th,
        .compatibility-table td {
            padding: 0.5rem;
            text-align: center;
            border: 1px solid var(--sage);
        }
        
        .compatibility-table th {
            background: var(--leaf-green);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .compatibility-table tr:hover {
            background: var(--cream);
        }
        
        .compat-good {
            background: #d4edda;
            color: #155724;
        }
        
        .compat-bad {
            background: #f8d7da;
            color: #721c24;
        }
        
        .compat-neutral {
            background: #f8f9fa;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-container > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            .garden-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-nav {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0.25rem 0.25rem 0 0.25rem;
            }
            
            .tab-btn {
                font-size: 0.9rem;
                padding: 0.6rem 1.2rem;
            }
            
            .panel {
                padding: 1rem;
            }
            
            .plant-selector {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            }
            
            .mode-selector {
                flex-direction: column;
            }
            
            .bed-comparison {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .bed-comparison-arrow {
                transform: rotate(90deg);
                margin: 0.5rem 0;
            }
        }
        
        /* iPhone and small smartphones */
        @media (max-width: 480px) {
            /* Performance: Disable expensive animations on mobile */
            * {
                animation: none !important;
                transition: none !important;
            }
            
            .tab-container {
                box-shadow: 0 2px 10px rgba(58, 47, 40, 0.06);
            }
            
            body {
                font-size: 0.95rem;
            }
            
            .container {
                padding: 0.5rem;
                max-width: 100%;
                overflow-x: hidden;
            }
            
            .tab-container {
                margin: 0;
            }
            
            .tab-nav {
                padding: 0.25rem 0.25rem 0 0.25rem;
            }
            
            .panel {
                padding: 1rem 0.75rem;
            }
            
            h1 {
                font-size: 2rem;
                letter-spacing: 0;
            }
            
            .subtitle {
                font-size: 0.95rem;
            }
            
            .panel {
                padding: 0.75rem;
                border-radius: 8px;
            }
            
            .panel h2 {
                font-size: 1.4rem;
                margin-bottom: 1rem;
            }
            
            .data-controls {
                flex-direction: column;
                gap: 0.5rem;
                margin-top: 1rem;
            }
            
            .data-controls .btn {
                width: 100%;
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }
            
            .language-switch {
                position: static;
                margin: 1rem auto;
                justify-content: center;
            }
            
            .year-selector {
                padding: 0.75rem;
                margin-bottom: 1.5rem;
            }
            
            .year-display {
                font-size: 1.3rem;
            }
            
            .wishlist-input {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .wishlist-input select,
            .wishlist-input button {
                width: 100%;
            }
            
            .wishlist-tag {
                font-size: 0.85rem;
                padding: 0.4rem 0.8rem;
            }
            
            .btn {
                font-size: 0.85rem;
                padding: 0.65rem 1.2rem;
            }
            
            .btn-suggest {
                font-size: 1rem;
                padding: 0.85rem;
            }
            
            .bed {
                padding: 1rem;
            }
            
            .bed-name {
                font-size: 1.2rem;
            }
            
            .plant-assignment {
                padding: 0.6rem;
                margin-bottom: 0.6rem;
            }
            
            .plant-name {
                font-size: 0.95rem;
            }
            
            .plant-meta {
                font-size: 0.8rem;
                gap: 0.5rem;
            }
            
            .nutrition-badge {
                font-size: 0.7rem;
                padding: 0.1rem 0.4rem;
            }
            
            .companion-tag {
                font-size: 0.75rem;
                padding: 0.3rem 0.6rem;
            }
            
            .suggestion-box {
                padding: 1rem;
            }
            
            .suggestion-box h4 {
                font-size: 1.2rem;
            }
            
            .suggestion-item {
                padding: 0.75rem;
                margin-bottom: 0.6rem;
            }
            
            .modal-content {
                padding: 1.5rem;
                width: 95%;
                max-width: 95%;
            }
            
            .modal-header h3 {
                font-size: 1.5rem;
            }
            
            .form-group {
                margin-bottom: 1.2rem;
            }
            
            .info-text {
                font-size: 0.85rem;
                padding: 0.85rem;
            }
            
            .compatibility-table {
                font-size: 0.75rem;
            }
            
            .compatibility-table th,
            .compatibility-table td {
                padding: 0.3rem;
            }
            
            #floatingInstallButton {
                bottom: 10px !important;
                right: 10px !important;
                left: 10px !important;
                width: auto !important;
                font-size: 0.85rem !important;
                padding: 0.7rem 1rem !important;
            }
            
            #headerInstallButton {
                display: inline-block !important;
            }
        }
        
        /* Very small devices (iPhone SE, etc.) */
        @media (max-width: 375px) {
            h1 {
                font-size: 1.75rem;
            }
            
            .subtitle {
                font-size: 0.9rem;
            }
            
            .container {
                padding: 0.75rem;
            }
            
            .panel {
                padding: 0.85rem;
            }
            
            .year-display {
                font-size: 1.2rem;
            }
            
            .bed-name {
                font-size: 1.1rem;
            }
        }
        
        /* Landscape mode for smartphones */
        @media (max-width: 968px) and (orientation: landscape) {
            .main-grid {
                grid-template-columns: 1fr 1.5fr;
            }
            
            .year-selector {
                padding: 0.5rem;
            }
        }
        
        /* Prevent horizontal scroll on all devices */
        body, html {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }
        
        * {
            max-width: 100%;
        }
        
        /* Fix for buttons extending beyond viewport */
        .btn-suggest,
        .btn-secondary,
        .btn-primary {
            max-width: 100%;
            word-wrap: break-word;
            white-space: normal;
            text-align: center;
        }
        /* Footer */
        footer {
            margin-top: 4rem;
            padding: 2rem;
            text-align: center;
            border-top: 2px solid var(--sage);
            background: linear-gradient(135deg, rgba(138, 168, 136, 0.05) 0%, rgba(74, 124, 89, 0.05) 100%);
        }
        
        footer p {
            margin: 0.5rem 0;
            color: var(--soil-medium);
            font-size: 0.95rem;
        }
        
        footer a {
            color: var(--leaf-green);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        footer a:hover {
            color: var(--soil-dark);
            transform: translateY(-2px);
        }
        
        .github-icon {
            font-size: 1.2rem;
        }
        
        @media (max-width: 480px) {
            footer {
                margin-top: 3rem;
                padding: 1.5rem 1rem;
            }
            
            footer p {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="language-switch">
                <button onclick="app.setLanguage('en')" class="active" id="langEN">EN</button>
                <button onclick="app.setLanguage('de')" id="langDE">DE</button>
                <button onclick="app.setLanguage('it')" id="langIT">IT</button>
            </div>
            
            <h1>üå± <span data-i18n="title">Beet Anything</span></h1>
            <p class="subtitle" data-i18n="subtitle">Crop Rotation & Companion Planting Made Easy</p>
            <div class="data-controls">
                <button class="btn btn-secondary btn-small" onclick="app.exportData()">
                    <span data-i18n="btn.export">üíæ Export Data</span>
                </button>
                <button class="btn btn-secondary btn-small" onclick="app.importData()">
                    <span data-i18n="btn.import">üìÇ Import Data</span>
                </button>
                <button class="btn btn-primary btn-small" onclick="app.showMatrix()">
                    <span data-i18n="btn.matrix">üìä View Matrix</span>
                </button>
                <button id="headerInstallButton" class="btn btn-primary btn-small" onclick="app.installAsApp()" style="display: none;">
                    <span data-i18n="btn.install">üì± Install as App</span>
                </button>
            </div>
        </header>
        
        <div class="main-grid">
            <!-- Unified Tab Container -->
            <div class="tab-container" style="grid-column: 1 / -1;">
                <!-- Tab Navigation -->
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="app.switchTab('garden')" data-i18n="tab.manual">üè° Manual Planning</button>
                    <button class="tab-btn" onclick="app.switchTab('optimizer')" data-i18n="tab.optimizer">üßÆ Easy Layout</button>
                </div>
                
                <!-- Tab Content Area -->
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
                    <!-- Tab: Manual Garden Planning -->
                    <div id="tab-garden" class="tab-content active" style="display: contents;">
            <!-- Left Panel: Controls -->
            <div>
                <div class="panel">
                    <h2 data-i18n="controls.title">Planning Controls</h2>
                    
                    <div class="year-selector">
                        <button onclick="app.changeYear(-1)">‚Üê</button>
                        <div class="year-display" id="yearDisplay">2024</div>
                        <button onclick="app.changeYear(1)">‚Üí</button>
                    </div>
                    
                    <!-- Wishlist Section -->
                    <div class="wishlist-section" style="margin-top: 1.5rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--soil-dark);" data-i18n="wishlist.title">Your Wishlist</h3>
                        <div class="wishlist-input">
                            <select id="vegetableSelect">
                                <option value="" data-i18n="wishlist.select">Select vegetable...</option>
                            </select>
                            <button class="btn btn-primary" onclick="app.addToWishlist()">
                                <span data-i18n="wishlist.add">Add</span>
                            </button>
                        </div>
                        <div class="wishlist-items" id="wishlistItems"></div>
                        
                        <button class="btn btn-suggest" onclick="app.generateSuggestions()">
                            <span data-i18n="suggestions.generate">‚ú® Suggest Garden Plan</span>
                        </button>
                        
                        <div id="suggestionsBox"></div>
                    </div>
                    
                    <!-- Year Rotation Wizard -->
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--sage);">
                        <button class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem;" onclick="app.showRotationWizard()">
                            <span data-i18n="wizard.rotate">üîÑ Rotate Last Year's Plan</span>
                        </button>
                        <p style="font-size: 0.8rem; color: var(--soil-medium); font-style: italic;" data-i18n="wizard.hint">
                            Suggests optimal bed rotation based on last year's planting
                        </p>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-secondary" style="width: 100%;" onclick="app.addBed()">
                            <span data-i18n="bed.add">+ Add Garden Bed</span>
                        </button>
                    </div>
                    
                    <div class="info-text" style="margin-top: 2rem;">
                        <strong data-i18n="info.title">üí° How it works:</strong><br>
                        <span data-i18n="info.text">Add vegetables to your wishlist, then click "Suggest Garden Plan" to get optimal bed assignments based on crop rotation and companion planting rules.</span>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel: Garden Beds -->
            <div class="panel">
                <h2>
                    <span data-i18n="beds.title">Garden Beds</span> - 
                    <span id="yearDisplayBeds">2024</span>
                </h2>
                
                <!-- Symbol Legend -->
                <div class="legend-box">
                    <details>
                        <summary>
                            <strong data-i18n="legend.title">Symbol Legend</strong> ‚ÑπÔ∏è
                        </summary>
                        <div class="legend-content">
                            <div class="legend-item">
                                <span class="companion-tag companion-good">‚úì <span data-i18n="legend.plant">Plant</span></span>
                                <span data-i18n="legend.goodCompanion">Good companion plant</span>
                            </div>
                            <div class="legend-item">
                                <span class="companion-tag companion-bad">‚úó <span data-i18n="legend.plant">Plant</span></span>
                                <span data-i18n="legend.badCompanion">Incompatible plant</span>
                            </div>
                            <div class="legend-item">
                                <span class="companion-tag companion-protection">üõ°Ô∏è <span data-i18n="legend.plant">Plant</span></span>
                                <span data-i18n="legend.pestProtection">Protects from pests</span>
                            </div>
                            <div class="legend-item">
                                <span class="companion-tag companion-warning">ü™≥ <span data-i18n="legend.plant">Plant</span></span>
                                <span data-i18n="legend.sharedPests">Shares pest vulnerabilities</span>
                            </div>
                            <div class="legend-item">
                                <span style="font-size: 1.2rem;">üêû</span>
                                <span data-i18n="legend.beneficials">Attracts beneficial insects</span>
                            </div>
                            <div class="legend-item">
                                <span class="nutrition-badge nutrition-high" style="min-width: 4rem; font-size: 0.85rem; padding: 0.35rem 0.6rem;" data-i18n="nutrition.high">High</span>
                                <span data-i18n="legend.highNutrition">High nutrient demand (heavy feeder)</span>
                            </div>
                            <div class="legend-item">
                                <span class="nutrition-badge nutrition-medium" style="min-width: 4rem; font-size: 0.85rem; padding: 0.35rem 0.6rem;" data-i18n="nutrition.medium">Medium</span>
                                <span data-i18n="legend.mediumNutrition">Medium nutrient demand</span>
                            </div>
                            <div class="legend-item">
                                <span class="nutrition-badge nutrition-low" style="min-width: 4rem; font-size: 0.85rem; padding: 0.35rem 0.6rem;" data-i18n="nutrition.low">Low</span>
                                <span data-i18n="legend.lowNutrition">Low nutrient demand (light feeder)</span>
                            </div>
                            <div class="legend-item">
                                <span style="font-size: 1.2rem;">üêå</span>
                                <span data-i18n="legend.slugVulnerable">Vulnerable to slugs/snails</span>
                            </div>
                            <div class="legend-item">
                                <span style="font-size: 1.2rem;">ü¶ü</span>
                                <span data-i18n="legend.flyingVulnerable">Vulnerable to flying pests</span>
                            </div>
                            <div class="legend-item">
                                <span style="font-size: 1.2rem;">üêõ</span>
                                <span data-i18n="legend.larvaeVulnerable">Vulnerable to larvae/caterpillars</span>
                            </div>
                            <div class="legend-item">
                                <span style="font-size: 1.2rem;">ü™≤</span>
                                <span data-i18n="legend.beetleVulnerable">Vulnerable to beetles</span>
                            </div>
                            <div class="legend-item legend-info">
                                <span style="font-size: 0.9rem; color: var(--soil-medium); font-style: italic;" data-i18n="legend.hoverInfo">Detailed information available by hovering over symbols</span>
                            </div>
                        </div>
                    </details>
                </div>
                
                <div class="garden-grid" id="gardenGrid"></div>
            </div>
            </div>
            <!-- End Tab: Garden -->
            
            <!-- Tab: Optimizer -->
            <div id="tab-optimizer" class="tab-content" style="grid-column: 1 / -1;">
                <div class="panel">
                    <h2>üßÆ <span data-i18n="optimizer.title">Easy Layout Optimizer</span></h2>
                    <p data-i18n="optimizer.description">Select plants and let the algorithm find the optimal garden layout for you.</p>
                    
                    <!-- Step 1: Plant Selection -->
                    <div style="margin-top: 2rem;">
                        <h3>üå± <span data-i18n="optimizer.selectPlants">Select Plants</span> (<span id="selectedCount">0</span>)</h3>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="plantSearch" placeholder="Search plants..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--sage); border-radius: 4px;">
                        </div>
                        <div class="plant-selector" id="plantSelector"></div>
                    </div>
                    
                    <!-- Step 2: Mode & Constraints -->
                    <div style="margin-top: 2rem;">
                        <h3>‚öôÔ∏è <span data-i18n="optimizer.configuration">Configuration</span></h3>
                        
                        <div class="mode-selector">
                            <label class="mode-option selected" id="mode-fresh">
                                <input type="radio" name="optimizerMode" value="fresh" checked onchange="app.setOptimizerMode('fresh')">
                                <div>
                                    <strong data-i18n="optimizer.modeFresh">üÜï Fresh Garden Plan</strong>
                                    <div style="font-size: 0.85rem; color: var(--soil-medium); margin-top: 0.25rem;" data-i18n="optimizer.modeFreshDesc">
                                        Start from scratch, ignore current layout
                                    </div>
                                </div>
                            </label>
                            <label class="mode-option" id="mode-fit">
                                <input type="radio" name="optimizerMode" value="fit" onchange="app.setOptimizerMode('fit')">
                                <div>
                                    <strong data-i18n="optimizer.modeFit">üîÑ Fit to Current Garden</strong>
                                    <div style="font-size: 0.85rem; color: var(--soil-medium); margin-top: 0.25rem;" data-i18n="optimizer.modeFitDesc">
                                        Respect bed count and crop rotation history
                                    </div>
                                </div>
                            </label>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <label data-i18n="optimizer.plantsPerBed">Plants per bed:</label>
                                <select id="maxPlantsPerBed" style="width: 100%; padding: 0.5rem; margin-top: 0.25rem;">
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4" selected>4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                </select>
                            </div>
                            <div>
                                <label data-i18n="optimizer.numBeds">Number of beds:</label>
                                <select id="numBeds" style="width: 100%; padding: 0.5rem; margin-top: 0.25rem;">
                                    <option value="auto" selected data-i18n="optimizer.auto">Auto-calculate</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="app.runOptimizer()" style="margin-top: 1.5rem; width: 100%;">
                            <span data-i18n="optimizer.calculate">üé≤ Calculate Optimal Layout</span>
                        </button>
                    </div>
                    
                    <!-- Step 3: Results (hidden initially) -->
                    <div id="optimizerResults" style="display: none;"></div>
                </div>
            </div>
            <!-- End Tab: Optimizer -->
            
            </div><!-- End tab content area grid -->
        </div><!-- End tab-container -->
    </div><!-- End main-grid -->
    
    <!-- Modal for Bed Assignment -->
    <div class="modal" id="bedModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.assignPlants">Assign Plants</h3>
                <button class="close-btn" onclick="app.closeModal()">√ó</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>
    
    <!-- Modal for Compatibility Matrix -->
    <div class="modal" id="matrixModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 data-i18n="modal.matrix">Companion Planting Matrix</h3>
                <button class="close-btn" onclick="app.closeMatrixModal()">√ó</button>
            </div>
            <div id="matrixBody"></div>
        </div>
    </div>
    
    <script>
        // ============================================
        // INTERNATIONALIZATION (i18n)
        // ============================================
        
        const translations = {
            en: {
                title: "Beet Anything",
                subtitle: "Crop Rotation & Companion Planting Made Easy",
                "btn.export": "üíæ Export Data",
                "btn.import": "üìÇ Import Data",
                "btn.matrix": "üìä View Matrix",
                "btn.install": "üì± Install as App",
                "controls.title": "Planning Board",
                "wishlist.title": "Your Wishlist",
                "wishlist.select": "Select vegetable...",
                "wishlist.add": "Add",
                "wishlist.empty": "No vegetables selected yet",
                "suggestions.generate": "‚ú® Suggest Garden Plan",
                "suggestions.title": "üåü Suggested Garden Plan",
                "suggestions.apply": "Apply to Bed",
                "suggestions.none": "No Suggestions Available",
                "suggestions.noneText": "Unable to place all vegetables. Try adding more beds or adjusting your wishlist.",
                "bed.add": "+ Add Garden Bed",
                "bed.remove": "Remove this bed and all its planting history?",
                "bed.empty": "Click to assign plants",
                "bed.previous": "Previous",
                "beds.title": "Garden Beds",
                "info.title": "üí° How it works:",
                "info.text": "Add vegetables to your wishlist, then click 'Suggest Garden Plan' to get optimal bed assignments based on crop rotation and companion planting rules.",
                "modal.assignPlants": "Assign Plants",
                "modal.bedName": "Bed Name",
                "modal.assignPlantsFor": "Assign Plants for",
                "modal.selectPlant": "Select plant...",
                "modal.addPlant": "Add Plant",
                "modal.currentPlants": "Current Plants",
                "modal.noPlants": "No plants assigned for this year",
                "modal.save": "Save",
                "modal.remove": "Remove",
                "modal.matrix": "Companion Planting Matrix",
                "matrix.legend": "Legend",
                "matrix.good": "Good companions",
                "matrix.bad": "Bad companions",
                "matrix.neutral": "Neutral",
                "nutrition.high": "high",
                "nutrition.medium": "medium",
                "nutrition.low": "low",
                "companion.with": "with",
                "reason.differentFamily": "Different plant family from previous year",
                "reason.sameFamily": "‚ö†Ô∏è Same plant family as previous year",
                "reason.restoresSoil": "Restores soil nutrients after heavy feeder",
                "reason.heavyAfterHeavy": "‚ö†Ô∏è High nutrient demand after heavy feeder",
                "reason.lowNutrient": "Low nutrient demand is soil-friendly",
                "reason.goodCompanion": "Good companion with",
                "reason.badCompanion": "‚ö†Ô∏è Poor companion with",
                "reason.samePlant2Years": "‚ö†Ô∏è Same vegetable was grown here 2 years ago",
                "reason.pestProtection": "üõ°Ô∏è Protects against pests",
                "reason.sharedPestRisk": "‚ö†Ô∏è Attracts same pests as",
                "reason.attractsBeneficials": "üêû Attracts beneficial insects",
                "install.alreadyInstalled": "The app is already installed! It's currently running as a PWA.",
                "install.iosTitle": "üì± App Installation on iPhone/iPad:",
                "install.iosSteps": "1. Tap the Share icon (‚ñ°‚Üë) at the bottom in Safari\n2. Scroll down\n3. Select 'Add to Home Screen'\n4. Tap 'Add'\n\nThe app will then appear on your home screen!\n\nNote: Only works in Safari (not Chrome/Firefox on iOS)",
                "install.androidTitle": "üì± App Installation on Android:",
                "install.androidSteps": "1. Open the Chrome menu (‚ãÆ) at the top right\n2. Select 'Install app' or 'Add to home screen'\n3. Confirm with 'Install'\n\nThe app will then appear on your home screen!",
                "install.desktopTitle": "üíª App Installation in Browser:",
                "install.desktopSteps": "Desktop (Chrome/Edge):\n1. Click the ‚äï icon in the address bar\n2. Or: Menu (‚ãÆ) ‚Üí 'Install app'\n3. Confirm with 'Install'\n\nMobile:\n- iPhone/Safari: Share (‚ñ°‚Üë) ‚Üí 'Add to Home Screen'\n- Android/Chrome: Menu (‚ãÆ) ‚Üí 'Install app'\n\nAdvantages:\n‚úì Works offline\n‚úì Faster startup\n‚úì Own app icon\n‚úì Fullscreen mode",
                "export.filename": "garden-plan",
                "import.success": "Data imported successfully!",
                "import.error": "Import failed. Please check the file format.",
                "footer.viewOnGitHub": "View on GitHub",
                "footer.madeWith": "Made with",
                "footer.forGardeners": "for gardeners",
                "legend.title": "Symbol Legend",
                "legend.plant": "Plant",
                "legend.goodCompanion": "Good companion plant",
                "legend.badCompanion": "Incompatible plant",
                "legend.pestProtection": "Protects from pests",
                "legend.sharedPests": "Shares pest vulnerabilities",
                "legend.beneficials": "Attracts beneficial insects",
                "legend.highNutrition": "High nutrient demand (heavy feeder)",
                "legend.mediumNutrition": "Medium nutrient demand",
                "legend.lowNutrition": "Low nutrient demand (light feeder)",
                "legend.slugVulnerable": "Vulnerable to slugs/snails",
                "legend.flyingVulnerable": "Vulnerable to flying pests (aphids, flies, moths)",
                "legend.larvaeVulnerable": "Vulnerable to larvae/caterpillars",
                "legend.beetleVulnerable": "Vulnerable to beetles",
                "legend.hoverInfo": "Tap on symbols for detailed information",
                "tooltip.beneficials": "Attracts beneficial insects: Ladybugs, Lacewings, Parasitic Wasps, Pollinators",
                "tooltip.traditionalCompanion": "Traditional good companion",
                "tooltip.protectsFrom": "Protects from",
                "tooltip.incompatible": "Incompatible: competes for nutrients or inhibits growth",
                "tooltip.slugs": "Slugs/Snails",
                "tooltip.flying": "Flying pests",
                "tooltip.larvae": "Larvae/Caterpillars",
                "tooltip.beetles": "Beetles",
                "data.clearAll": "Clear All Data",
                "data.clearConfirm": "‚ö†Ô∏è Are you sure you want to completely delete all garden data?\n\nThis action CANNOT be undone!",
                "data.offerBackup": "Would you like to save a backup before deleting?\n\nRecommended: Press OK to create backup first.\nPress Cancel to delete without backup.",
                "data.cleared": "All data has been cleared. Page will reload.",
                "data.backupSaved": "Backup saved! Now deleting all data...",
                "data.version": "Data version",
                "pest.slugs": "slugs",
                "pest.aphids": "aphids",
                "pest.whitefly": "whitefly",
                "pest.thrips": "thrips",
                "pest.onion-fly": "onion fly",
                "pest.carrot-fly": "carrot fly",
                "pest.cabbage-root-fly": "cabbage root fly",
                "pest.leek-moth": "leek moth",
                "pest.cabbage-white": "cabbage white butterfly",
                "pest.hornworms": "hornworms",
                "pest.pea-moth": "pea moth",
                "pest.corn-borer": "corn borer",
                "pest.earworm": "earworm",
                "pest.wireworms": "wireworms",
                "pest.root-maggot": "root maggot",
                "pest.potato-beetle": "potato beetle",
                "pest.bean-beetle": "bean beetle",
                "pest.cucumber-beetle": "cucumber beetle",
                "pest.japanese-beetle": "Japanese beetle",
                "pest.flea-beetle": "flea beetle",
                "pest.squash-bug": "squash bug",
                "pest.spider-mites": "spider mites",
                "pest.leaf-miners": "leaf miners",
                "tab.manual": "üè° Manual Planning",
                "tab.optimizer": "üßÆ Easy Layout",
                "wizard.rotate": "üîÑ Rotate Last Year's Plan",
                "wizard.hint": "Suggests optimal bed rotation based on last year's planting",
                "wizard.title": "Year Rotation Wizard",
                "wizard.noPrevious": "No plantings found from previous year",
                "wizard.sameYear": "Already viewing current calendar year",
                "wizard.copyBeds": "Copy beds from last year?",
                "wizard.copyBedsDesc": "This will create the same number of beds and suggest optimal rotation",
                "wizard.apply": "Apply Rotation",
                "wizard.cancel": "Cancel",
                "wizard.applied": "Rotation applied successfully!",
                "optimizer.title": "Easy Layout Optimizer",
                "optimizer.description": "Select plants and let the algorithm find the optimal garden layout for you.",
                "optimizer.selectPlants": "Select Plants",
                "optimizer.configuration": "Configuration",
                "optimizer.modeFresh": "üÜï Fresh Garden Plan",
                "optimizer.modeFreshDesc": "Start from scratch, ignore current layout",
                "optimizer.modeFit": "üîÑ Fit to Current Garden",
                "optimizer.modeFitDesc": "Respect bed count and crop rotation history",
                "optimizer.plantsPerBed": "Plants per bed:",
                "optimizer.numBeds": "Number of beds:",
                "optimizer.auto": "Auto-calculate",
                "optimizer.calculate": "üé≤ Calculate Optimal Layout",
                "optimizer.score": "Score:",
                "optimizer.excellent": "Excellent",
                "optimizer.veryGood": "Very Good",
                "optimizer.good": "Good",
                "optimizer.fair": "Fair",
                "optimizer.poor": "Poor",
                "optimizer.results": "Optimization Results",
                "optimizer.bed": "Bed",
                "optimizer.was": "Was:",
                "optimizer.now": "Now:",
                "optimizer.reasons": "Reasons:",
                "optimizer.summary": "Summary:",
                "optimizer.apply": "‚úì Apply Layout",
                "optimizer.newCalc": "üîÑ New Calculation",
                "optimizer.noSelection": "Please select at least 3 plants",
                "optimizer.applyConfirm": "Apply this layout? This will clear current year plantings and apply the optimized layout.",
                "optimizer.applied": "Layout applied successfully!",
                "optimizer.unplaced": "Could not place all plants",
                "optimizer.unplacedPlants": "Not placed",
                "optimizer.improvements": "üí° How to improve",
                "optimizer.improveBeds": "Increase number of beds",
                "optimizer.improvePlantsPerBed": "Increase plants per bed",
                "optimizer.improveRemovePlants": "Remove some plants from selection",
                "optimizer.improveRotation": "Adjust crop rotation constraints (Fit mode)"
            },
            de: {
                title: "Beet Anything",
                subtitle: "Fruchtfolge & Mischkultur leicht gemacht",
                "btn.export": "üíæ Daten exportieren",
                "btn.import": "üìÇ Daten importieren",
                "btn.matrix": "üìä Matrix anzeigen",
                "btn.install": "üì± Als App installieren",
                "controls.title": "Planungs√ºbersicht",
                "wishlist.title": "Ihre Wunschliste",
                "wishlist.select": "Gem√ºse ausw√§hlen...",
                "wishlist.add": "Hinzuf√ºgen",
                "wishlist.empty": "Noch kein Gem√ºse ausgew√§hlt",
                "suggestions.generate": "‚ú® Gartenplan vorschlagen",
                "suggestions.title": "üåü Vorgeschlagener Gartenplan",
                "suggestions.apply": "Auf Beet anwenden",
                "suggestions.none": "Keine Vorschl√§ge verf√ºgbar",
                "suggestions.noneText": "Alle Gem√ºsesorten konnten nicht platziert werden. Versuchen Sie, mehr Beete hinzuzuf√ºgen oder Ihre Wunschliste anzupassen.",
                "bed.add": "+ Gartenbeet hinzuf√ºgen",
                "bed.remove": "Dieses Beet und alle seine Pflanzungen entfernen?",
                "bed.empty": "Klicken zum Zuweisen von Pflanzen",
                "bed.previous": "Vorjahr",
                "beds.title": "Gartenbeete",
                "info.title": "üí° So funktioniert's:",
                "info.text": "F√ºgen Sie Gem√ºse zu Ihrer Wunschliste hinzu und klicken Sie dann auf 'Gartenplan vorschlagen', um optimale Beetzuweisungen basierend auf Fruchtfolge und Mischkulturregeln zu erhalten.",
                "modal.assignPlants": "Pflanzen zuweisen",
                "modal.bedName": "Beetname",
                "modal.assignPlantsFor": "Pflanzen zuweisen f√ºr",
                "modal.selectPlant": "Pflanze ausw√§hlen...",
                "modal.addPlant": "Pflanze hinzuf√ºgen",
                "modal.currentPlants": "Aktuelle Pflanzen",
                "modal.noPlants": "Keine Pflanzen f√ºr dieses Jahr zugewiesen",
                "modal.save": "Speichern",
                "modal.remove": "Entfernen",
                "modal.matrix": "Mischkultur-Matrix",
                "matrix.legend": "Legende",
                "matrix.good": "Gute Begleiter",
                "matrix.bad": "Schlechte Begleiter",
                "matrix.neutral": "Neutral",
                "nutrition.high": "Hoch",
                "nutrition.medium": "Mittel",
                "nutrition.low": "Niedrig",
                "companion.with": "mit",
                "reason.differentFamily": "Andere Pflanzenfamilie als im Vorjahr",
                "reason.sameFamily": "‚ö†Ô∏è Gleiche Pflanzenfamilie wie im Vorjahr",
                "reason.restoresSoil": "Regeneriert Bodenn√§hrstoffe nach Starkzehrer",
                "reason.heavyAfterHeavy": "‚ö†Ô∏è Hoher N√§hrstoffbedarf nach Starkzehrer",
                "reason.lowNutrient": "Niedriger N√§hrstoffbedarf schont den Boden",
                "reason.goodCompanion": "Guter Begleiter von",
                "reason.badCompanion": "‚ö†Ô∏è Schlechter Begleiter von",
                "reason.samePlant2Years": "‚ö†Ô∏è Gleiches Gem√ºse wurde hier vor 2 Jahren angebaut",
                "reason.pestProtection": "üõ°Ô∏è Sch√ºtzt vor Sch√§dlingen",
                "reason.sharedPestRisk": "‚ö†Ô∏è Zieht gleiche Sch√§dlinge an wie",
                "reason.attractsBeneficials": "üêû Lockt N√ºtzlinge an",
                "install.alreadyInstalled": "Die App ist bereits installiert! Sie l√§uft gerade als PWA.",
                "install.iosTitle": "üì± App-Installation auf iPhone/iPad:",
                "install.iosSteps": "1. Tippen Sie auf das Teilen-Symbol (‚ñ°‚Üë) unten in Safari\n2. Scrollen Sie nach unten\n3. W√§hlen Sie 'Zum Home-Bildschirm'\n4. Tippen Sie auf 'Hinzuf√ºgen'\n\nDie App erscheint dann auf Ihrem Home-Bildschirm!\n\nHinweis: Funktioniert nur in Safari (nicht Chrome/Firefox auf iOS)",
                "install.androidTitle": "üì± App-Installation auf Android:",
                "install.androidSteps": "1. √ñffnen Sie das Chrome-Men√º (‚ãÆ) oben rechts\n2. W√§hlen Sie 'App installieren' oder 'Zum Startbildschirm hinzuf√ºgen'\n3. Best√§tigen Sie mit 'Installieren'\n\nDie App erscheint dann auf Ihrem Home-Bildschirm!",
                "install.desktopTitle": "üíª App-Installation im Browser:",
                "install.desktopSteps": "Desktop (Chrome/Edge):\n1. Klicken Sie auf das ‚äï Symbol in der Adressleiste\n2. Oder: Men√º (‚ãÆ) ‚Üí 'App installieren'\n3. Best√§tigen Sie mit 'Installieren'\n\nMobile:\n- iPhone/Safari: Teilen (‚ñ°‚Üë) ‚Üí 'Zum Home-Bildschirm'\n- Android/Chrome: Men√º (‚ãÆ) ‚Üí 'App installieren'\n\nVorteile:\n‚úì Offline nutzbar\n‚úì Schnellerer Start\n‚úì Eigenes App-Icon\n‚úì Vollbild-Modus",
                "export.filename": "gartenplan",
                "import.success": "Daten erfolgreich importiert!",
                "import.error": "Import fehlgeschlagen. Bitte √ºberpr√ºfen Sie das Dateiformat.",
                "footer.viewOnGitHub": "Auf GitHub ansehen",
                "footer.madeWith": "Gemacht mit",
                "footer.forGardeners": "f√ºr G√§rtner",
                "legend.title": "Symbol-Legende",
                "legend.plant": "Pflanze",
                "legend.goodCompanion": "Guter Begleitpflanze",
                "legend.badCompanion": "Unvertr√§gliche Pflanze",
                "legend.pestProtection": "Sch√ºtzt vor Sch√§dlingen",
                "legend.sharedPests": "Teilt Sch√§dlingsanf√§lligkeit",
                "legend.beneficials": "Lockt N√ºtzlinge an",
                "legend.highNutrition": "Hoher N√§hrstoffbedarf (Starkzehrer)",
                "legend.mediumNutrition": "Mittlerer N√§hrstoffbedarf (Mittelzehrer)",
                "legend.lowNutrition": "Niedriger N√§hrstoffbedarf (Schwachzehrer)",
                "legend.slugVulnerable": "Anf√§llig f√ºr Schnecken",
                "legend.flyingVulnerable": "Anf√§llig f√ºr fliegende Sch√§dlinge (Blattl√§use, Fliegen, Motten)",
                "legend.larvaeVulnerable": "Anf√§llig f√ºr Larven/Raupen",
                "legend.beetleVulnerable": "Anf√§llig f√ºr K√§fer",
                "legend.hoverInfo": "Detailinformationen durch Tippen auf Symbole verf√ºgbar",
                "tooltip.beneficials": "Lockt N√ºtzlinge an: Marienk√§fer, Florfliegen, Schlupfwespen, Best√§uber",
                "tooltip.traditionalCompanion": "Traditionell gute Begleitpflanze",
                "tooltip.protectsFrom": "Sch√ºtzt vor",
                "tooltip.incompatible": "Unvertr√§glich: Konkurriert um N√§hrstoffe oder hemmt Wachstum",
                "tooltip.slugs": "Schnecken",
                "tooltip.flying": "Fliegende Sch√§dlinge",
                "tooltip.larvae": "Larven/Raupen",
                "tooltip.beetles": "K√§fer",
                "data.clearAll": "Alle Daten l√∂schen",
                "data.clearConfirm": "‚ö†Ô∏è Sind Sie sicher, dass Sie alle Gartendaten vollst√§ndig l√∂schen m√∂chten?\n\nDiese Aktion kann NICHT r√ºckg√§ngig gemacht werden!",
                "data.offerBackup": "M√∂chten Sie ein Backup speichern vor dem L√∂schen?\n\nEmpfohlen: Dr√ºcken Sie OK f√ºr Backup.\nDr√ºcken Sie Abbrechen um ohne Backup zu l√∂schen.",
                "data.cleared": "Alle Daten wurden gel√∂scht. Seite wird neu geladen.",
                "data.backupSaved": "Backup gespeichert! L√∂sche jetzt alle Daten...",
                "data.version": "Datenversion",
                "pest.slugs": "Schnecken",
                "pest.aphids": "Blattl√§use",
                "pest.whitefly": "Wei√üe Fliege",
                "pest.thrips": "Thripse",
                "pest.onion-fly": "Zwiebelfliege",
                "pest.carrot-fly": "M√∂hrenfliege",
                "pest.cabbage-root-fly": "Kohlfliege",
                "pest.leek-moth": "Lauchmotte",
                "pest.cabbage-white": "Kohlwei√üling",
                "pest.hornworms": "Hornw√ºrmer",
                "pest.pea-moth": "Erbsenmotte",
                "pest.corn-borer": "Maisz√ºnsler",
                "pest.earworm": "Ohrenbohrer",
                "pest.wireworms": "Drahtw√ºrmer",
                "pest.root-maggot": "Wurzelmade",
                "pest.potato-beetle": "Kartoffelk√§fer",
                "pest.bean-beetle": "Bohnenk√§fer",
                "pest.cucumber-beetle": "Gurkenk√§fer",
                "pest.japanese-beetle": "Japank√§fer",
                "pest.flea-beetle": "Erdfloh",
                "pest.squash-bug": "K√ºrbis-Wanze",
                "pest.spider-mites": "Spinnmilben",
                "pest.leaf-miners": "Minierfliegen",
                "tab.manual": "üè° Manuelle Planung",
                "tab.optimizer": "üßÆ Easy Layout",
                "wizard.rotate": "üîÑ Vorjahresplan rotieren",
                "wizard.hint": "Schl√§gt optimale Beetrotation basierend auf Vorjahresbepflanzung vor",
                "wizard.title": "Jahres-Rotations-Assistent",
                "wizard.noPrevious": "Keine Bepflanzung vom Vorjahr gefunden",
                "wizard.sameYear": "Aktuelles Kalenderjahr wird bereits angezeigt",
                "wizard.copyBeds": "Beete vom Vorjahr √ºbernehmen?",
                "wizard.copyBedsDesc": "Dies erstellt dieselbe Anzahl Beete und schl√§gt optimale Rotation vor",
                "wizard.apply": "Rotation anwenden",
                "wizard.cancel": "Abbrechen",
                "wizard.applied": "Rotation erfolgreich angewendet!",
                "optimizer.title": "Easy Layout Optimierer",
                "optimizer.description": "W√§hlen Sie Pflanzen aus und lassen Sie den Algorithmus das optimale Gartenlayout finden.",
                "optimizer.selectPlants": "Pflanzen ausw√§hlen",
                "optimizer.configuration": "Konfiguration",
                "optimizer.modeFresh": "üÜï Neuer Gartenplan",
                "optimizer.modeFreshDesc": "Von Grund auf neu, ignoriert aktuelles Layout",
                "optimizer.modeFit": "üîÑ An aktuellen Garten anpassen",
                "optimizer.modeFitDesc": "Ber√ºcksichtigt Beetanzahl und Fruchtfolge-Historie",
                "optimizer.plantsPerBed": "Pflanzen pro Beet:",
                "optimizer.numBeds": "Anzahl Beete:",
                "optimizer.auto": "Automatisch berechnen",
                "optimizer.calculate": "üé≤ Optimales Layout berechnen",
                "optimizer.score": "Bewertung:",
                "optimizer.excellent": "Ausgezeichnet",
                "optimizer.veryGood": "Sehr gut",
                "optimizer.good": "Gut",
                "optimizer.fair": "Ausreichend",
                "optimizer.poor": "Schlecht",
                "optimizer.results": "Optimierungsergebnisse",
                "optimizer.bed": "Beet",
                "optimizer.was": "War:",
                "optimizer.now": "Jetzt:",
                "optimizer.reasons": "Gr√ºnde:",
                "optimizer.summary": "Zusammenfassung:",
                "optimizer.apply": "‚úì Layout √ºbernehmen",
                "optimizer.newCalc": "üîÑ Neue Berechnung",
                "optimizer.noSelection": "Bitte w√§hlen Sie mindestens 3 Pflanzen aus",
                "optimizer.applyConfirm": "Dieses Layout √ºbernehmen? Dies l√∂scht die Bepflanzung des aktuellen Jahres und wendet das optimierte Layout an.",
                "optimizer.applied": "Layout erfolgreich √ºbernommen!",
                "optimizer.unplaced": "Nicht alle Pflanzen konnten platziert werden",
                "optimizer.unplacedPlants": "Nicht platziert",
                "optimizer.improvements": "üí° Verbesserungsm√∂glichkeiten",
                "optimizer.improveBeds": "Anzahl der Beete erh√∂hen",
                "optimizer.improvePlantsPerBed": "Pflanzen pro Beet erh√∂hen",
                "optimizer.improveRemovePlants": "Einige Pflanzen aus Auswahl entfernen",
                "optimizer.improveRotation": "Fruchtfolge-Einschr√§nkungen anpassen (Fit-Modus)"
            },
            it: {
                title: "Beet Anything",
                subtitle: "Rotazione Colturale e Consociazione Facile",
                "btn.export": "üíæ Esporta Dati",
                "btn.import": "üìÇ Importa Dati",
                "btn.matrix": "üìä Visualizza Matrice",
                "btn.install": "üì± Installa come App",
                "controls.title": "Pannello di Pianificazione",
                "wishlist.title": "La Tua Lista Desideri",
                "wishlist.select": "Seleziona ortaggio...",
                "wishlist.add": "Aggiungi",
                "wishlist.empty": "Nessun ortaggio selezionato ancora",
                "suggestions.generate": "‚ú® Suggerisci Piano Orto",
                "suggestions.title": "üåü Piano Orto Suggerito",
                "suggestions.apply": "Applica all'Aiuola",
                "suggestions.none": "Nessun Suggerimento Disponibile",
                "suggestions.noneText": "Impossibile posizionare tutti gli ortaggi. Prova ad aggiungere pi√π aiuole o modificare la tua lista desideri.",
                "bed.add": "+ Aggiungi Aiuola",
                "bed.remove": "Rimuovere questa aiuola e tutta la sua cronologia di piantagione?",
                "bed.empty": "Clicca per assegnare piante",
                "bed.previous": "Anno Precedente",
                "beds.title": "Aiuole dell'Orto",
                "info.title": "üí° Come funziona:",
                "info.text": "Aggiungi ortaggi alla tua lista desideri, poi clicca 'Suggerisci Piano Orto' per ottenere assegnazioni ottimali basate sulla rotazione colturale e regole di consociazione.",
                "modal.assignPlants": "Assegna Piante",
                "modal.bedName": "Nome Aiuola",
                "modal.assignPlantsFor": "Assegna Piante per",
                "modal.selectPlant": "Seleziona pianta...",
                "modal.addPlant": "Aggiungi Pianta",
                "modal.currentPlants": "Piante Attuali",
                "modal.noPlants": "Nessuna pianta assegnata per quest'anno",
                "modal.save": "Salva",
                "modal.remove": "Rimuovi",
                "modal.matrix": "Matrice di Consociazione",
                "matrix.legend": "Legenda",
                "matrix.good": "Buoni compagni",
                "matrix.bad": "Cattivi compagni",
                "matrix.neutral": "Neutro",
                "nutrition.high": "alto",
                "nutrition.medium": "medio",
                "nutrition.low": "basso",
                "companion.with": "con",
                "reason.differentFamily": "Famiglia di piante diversa dall'anno precedente",
                "reason.sameFamily": "‚ö†Ô∏è Stessa famiglia di piante dell'anno precedente",
                "reason.restoresSoil": "Ripristina i nutrienti del suolo dopo pianta esigente",
                "reason.heavyAfterHeavy": "‚ö†Ô∏è Alta richiesta di nutrienti dopo pianta esigente",
                "reason.lowNutrient": "Bassa richiesta di nutrienti preserva il suolo",
                "reason.goodCompanion": "Buon compagno con",
                "reason.badCompanion": "‚ö†Ô∏è Cattivo compagno con",
                "reason.samePlant2Years": "‚ö†Ô∏è Stesso ortaggio coltivato qui 2 anni fa",
                "reason.pestProtection": "üõ°Ô∏è Protegge dai parassiti",
                "reason.sharedPestRisk": "‚ö†Ô∏è Attrae stessi parassiti di",
                "reason.attractsBeneficials": "üêû Attrae insetti utili",
                "install.alreadyInstalled": "L'app √® gi√† installata! Sta funzionando come PWA.",
                "install.iosTitle": "üì± Installazione App su iPhone/iPad:",
                "install.iosSteps": "1. Tocca l'icona Condividi (‚ñ°‚Üë) in basso in Safari\n2. Scorri verso il basso\n3. Seleziona 'Aggiungi a Home'\n4. Tocca 'Aggiungi'\n\nL'app apparir√† sulla tua schermata home!\n\nNota: Funziona solo in Safari (non Chrome/Firefox su iOS)",
                "install.androidTitle": "üì± Installazione App su Android:",
                "install.androidSteps": "1. Apri il menu Chrome (‚ãÆ) in alto a destra\n2. Seleziona 'Installa app' o 'Aggiungi a schermata Home'\n3. Conferma con 'Installa'\n\nL'app apparir√† sulla tua schermata home!",
                "install.desktopTitle": "üíª Installazione App nel Browser:",
                "install.desktopSteps": "Desktop (Chrome/Edge):\n1. Clicca sull'icona ‚äï nella barra degli indirizzi\n2. Oppure: Menu (‚ãÆ) ‚Üí 'Installa app'\n3. Conferma con 'Installa'\n\nMobile:\n- iPhone/Safari: Condividi (‚ñ°‚Üë) ‚Üí 'Aggiungi a Home'\n- Android/Chrome: Menu (‚ãÆ) ‚Üí 'Installa app'\n\nVantaggi:\n‚úì Funziona offline\n‚úì Avvio pi√π veloce\n‚úì Icona app propria\n‚úì Modalit√† schermo intero",
                "export.filename": "piano-orto",
                "import.success": "Dati importati con successo!",
                "import.error": "Importazione fallita. Controlla il formato del file.",
                "footer.viewOnGitHub": "Visualizza su GitHub",
                "footer.madeWith": "Fatto con",
                "footer.forGardeners": "per giardinieri",
                "legend.title": "Leggenda dei Simboli",
                "legend.plant": "Pianta",
                "legend.goodCompanion": "Buona pianta compagna",
                "legend.badCompanion": "Pianta incompatibile",
                "legend.pestProtection": "Protegge dai parassiti",
                "legend.sharedPests": "Condivide vulnerabilit√† ai parassiti",
                "legend.beneficials": "Attrae insetti utili",
                "legend.highNutrition": "Alto fabbisogno di nutrienti (alimentatore pesante)",
                "legend.mediumNutrition": "Medio fabbisogno di nutrienti",
                "legend.lowNutrition": "Basso fabbisogno di nutrienti (alimentatore leggero)",
                "legend.slugVulnerable": "Vulnerabile a lumache",
                "legend.flyingVulnerable": "Vulnerabile a parassiti volanti (afidi, mosche, falene)",
                "legend.larvaeVulnerable": "Vulnerabile a larve/bruchi",
                "legend.beetleVulnerable": "Vulnerabile a coleotteri",
                "legend.hoverInfo": "Informazioni dettagliate toccando i simboli",
                "tooltip.beneficials": "Attrae insetti utili: Coccinelle, Crisope, Vespe parassite, Impollinatori",
                "tooltip.traditionalCompanion": "Tradizionalmente buona pianta compagna",
                "tooltip.protectsFrom": "Protegge da",
                "tooltip.incompatible": "Incompatibile: compete per nutrienti o inibisce la crescita",
                "tooltip.slugs": "Lumache",
                "tooltip.flying": "Parassiti volanti",
                "tooltip.larvae": "Larve/Bruchi",
                "tooltip.beetles": "Coleotteri",
                "data.clearAll": "Cancella tutti i dati",
                "data.clearConfirm": "‚ö†Ô∏è Sei sicuro di voler cancellare completamente tutti i dati del giardino?\n\nQuesta azione NON pu√≤ essere annullata!",
                "data.offerBackup": "Vuoi salvare un backup prima di cancellare?\n\nConsigliato: Premi OK per creare il backup.\nPremi Annulla per cancellare senza backup.",
                "data.cleared": "Tutti i dati sono stati cancellati. La pagina verr√† ricaricata.",
                "data.backupSaved": "Backup salvato! Cancellazione di tutti i dati...",
                "data.version": "Versione dati",
                "pest.slugs": "lumache",
                "pest.aphids": "afidi",
                "pest.whitefly": "mosca bianca",
                "pest.thrips": "tripidi",
                "pest.onion-fly": "mosca della cipolla",
                "pest.carrot-fly": "mosca della carota",
                "pest.cabbage-root-fly": "mosca del cavolo",
                "pest.leek-moth": "tignola del porro",
                "pest.cabbage-white": "cavolaia",
                "pest.hornworms": "sfinge del pomodoro",
                "pest.pea-moth": "tignola del pisello",
                "pest.corn-borer": "piralide del mais",
                "pest.earworm": "elateridi",
                "pest.wireworms": "ferretto",
                "pest.root-maggot": "larva radicale",
                "pest.potato-beetle": "dorifora",
                "pest.bean-beetle": "tonchio del fagiolo",
                "pest.cucumber-beetle": "criocera del cetriolo",
                "pest.japanese-beetle": "scarabeo giapponese",
                "pest.flea-beetle": "altica",
                "pest.squash-bug": "cimice della zucca",
                "pest.spider-mites": "ragnetto rosso",
                "pest.leaf-miners": "minatrice",
                "tab.manual": "üè° Pianificazione manuale",
                "tab.optimizer": "üßÆ Easy Layout",
                "wizard.rotate": "üîÑ Ruota piano anno scorso",
                "wizard.hint": "Suggerisce rotazione ottimale basata sulla piantagione dell'anno scorso",
                "wizard.title": "Assistente Rotazione Annuale",
                "wizard.noPrevious": "Nessuna piantagione trovata dall'anno scorso",
                "wizard.sameYear": "Anno corrente gi√† visualizzato",
                "wizard.copyBeds": "Copiare aiuole dall'anno scorso?",
                "wizard.copyBedsDesc": "Questo creer√† lo stesso numero di aiuole e suggerir√† la rotazione ottimale",
                "wizard.apply": "Applica rotazione",
                "wizard.cancel": "Annulla",
                "wizard.applied": "Rotazione applicata con successo!",
                "optimizer.title": "Ottimizzatore Easy Layout",
                "optimizer.description": "Seleziona le piante e lascia che l'algoritmo trovi il layout ottimale del giardino.",
                "optimizer.selectPlants": "Seleziona piante",
                "optimizer.configuration": "Configurazione",
                "optimizer.modeFresh": "üÜï Nuovo piano giardino",
                "optimizer.modeFreshDesc": "Ricomincia da zero, ignora il layout attuale",
                "optimizer.modeFit": "üîÑ Adatta al giardino attuale",
                "optimizer.modeFitDesc": "Rispetta il numero di aiuole e la storia della rotazione",
                "optimizer.plantsPerBed": "Piante per aiuola:",
                "optimizer.numBeds": "Numero di aiuole:",
                "optimizer.auto": "Calcola automaticamente",
                "optimizer.calculate": "üé≤ Calcola layout ottimale",
                "optimizer.score": "Punteggio:",
                "optimizer.excellent": "Eccellente",
                "optimizer.veryGood": "Molto buono",
                "optimizer.good": "Buono",
                "optimizer.fair": "Sufficiente",
                "optimizer.poor": "Scarso",
                "optimizer.results": "Risultati ottimizzazione",
                "optimizer.bed": "Aiuola",
                "optimizer.was": "Era:",
                "optimizer.now": "Ora:",
                "optimizer.reasons": "Motivi:",
                "optimizer.summary": "Riepilogo:",
                "optimizer.apply": "‚úì Applica layout",
                "optimizer.newCalc": "üîÑ Nuovo calcolo",
                "optimizer.noSelection": "Seleziona almeno 3 piante",
                "optimizer.applyConfirm": "Applicare questo layout? Questo canceller√† le piantagioni dell'anno corrente e applicher√† il layout ottimizzato.",
                "optimizer.applied": "Layout applicato con successo!",
                "optimizer.unplaced": "Impossibile posizionare tutte le piante",
                "optimizer.unplacedPlants": "Non posizionato",
                "optimizer.improvements": "üí° Come migliorare",
                "optimizer.improveBeds": "Aumentare il numero di aiuole",
                "optimizer.improvePlantsPerBed": "Aumentare piante per aiuola",
                "optimizer.improveRemovePlants": "Rimuovere alcune piante dalla selezione",
                "optimizer.improveRotation": "Regolare vincoli di rotazione (modalit√† Fit)"
            }
        };
        
        // ============================================
        // CORE CLASS HIERARCHY (English names)
        // ============================================
        
        /**
         * Base class for vegetable information
         */
        class Vegetable {
            constructor(id, nameEN, nameDE, nameIT, nutrition, family, pestData = {}) {
                this.id = id;
                this.nameEN = nameEN;
                this.nameDE = nameDE;
                this.nameIT = nameIT;
                this.nutrition = nutrition; // 'high', 'medium', 'low'
                this.family = family;
                this.goodCompanions = [];
                this.badCompanions = [];
                
                // Pest & beneficial insect data
                this.susceptibleTo = pestData.susceptibleTo || [];
                this.protectsAgainst = pestData.protectsAgainst || [];
                this.attractsBeneficials = pestData.attractsBeneficials || false;
            }
            
            addGoodCompanion(vegetableId) {
                if (!this.goodCompanions.includes(vegetableId)) {
                    this.goodCompanions.push(vegetableId);
                }
            }
            
            addBadCompanion(vegetableId) {
                if (!this.badCompanions.includes(vegetableId)) {
                    this.badCompanions.push(vegetableId);
                }
            }
            
            isCompatibleWith(vegetableId) {
                if (this.badCompanions.includes(vegetableId)) return -1;
                if (this.goodCompanions.includes(vegetableId)) return 1;
                return 0;
            }
            
            // NEW: Check if this plant protects another from specific pests
            protectsPlant(otherVegetable) {
                return this.protectsAgainst.some(pest => 
                    otherVegetable.susceptibleTo.includes(pest)
                );
            }
            
            // NEW: Check if plants share pest vulnerabilities
            sharesVulnerabilitiesWith(otherVegetable) {
                return this.susceptibleTo.filter(pest =>
                    otherVegetable.susceptibleTo.includes(pest)
                );
            }
            
            // NEW: Get pest icons for this plant
            getPestIcons() {
                const icons = {
                    slugs: false,
                    flying: false,
                    larvae: false,
                    beetles: false
                };
                
                // Categorize pests
                const slugPests = ['slugs'];
                const flyingPests = ['aphids', 'whitefly', 'thrips', 'onion-fly', 'carrot-fly', 'cabbage-root-fly', 'leek-moth'];
                const larvaePests = ['cabbage-white', 'hornworms', 'pea-moth', 'corn-borer', 'earworm', 'wireworms', 'root-maggot'];
                const beetlePests = ['potato-beetle', 'bean-beetle', 'cucumber-beetle', 'japanese-beetle', 'flea-beetle', 'squash-bug'];
                
                for (const pest of this.susceptibleTo) {
                    if (slugPests.includes(pest)) icons.slugs = true;
                    if (flyingPests.includes(pest)) icons.flying = true;
                    if (larvaePests.includes(pest)) icons.larvae = true;
                    if (beetlePests.includes(pest)) icons.beetles = true;
                }
                
                return icons;
            }
            
            // NEW: Get detailed pest list by category
            getPestsByCategory() {
                const categories = {
                    slugs: [],
                    flying: [],
                    larvae: [],
                    beetles: [],
                    other: []
                };
                
                const slugPests = ['slugs'];
                const flyingPests = ['aphids', 'whitefly', 'thrips', 'onion-fly', 'carrot-fly', 'cabbage-root-fly', 'leek-moth'];
                const larvaePests = ['cabbage-white', 'hornworms', 'pea-moth', 'corn-borer', 'earworm', 'wireworms', 'root-maggot'];
                const beetlePests = ['potato-beetle', 'bean-beetle', 'cucumber-beetle', 'japanese-beetle', 'flea-beetle', 'squash-bug'];
                
                for (const pest of this.susceptibleTo) {
                    if (slugPests.includes(pest)) categories.slugs.push(pest);
                    else if (flyingPests.includes(pest)) categories.flying.push(pest);
                    else if (larvaePests.includes(pest)) categories.larvae.push(pest);
                    else if (beetlePests.includes(pest)) categories.beetles.push(pest);
                    else categories.other.push(pest);
                }
                
                return categories;
            }
            
            getName(lang = 'en') {
                if (lang === 'de') return this.nameDE;
                if (lang === 'it') return this.nameIT;
                return this.nameEN;
            }
            
            toJSON() {
                return {
                    id: this.id,
                    nameEN: this.nameEN,
                    nameDE: this.nameDE,
                    nameIT: this.nameIT,
                    nutrition: this.nutrition,
                    family: this.family,
                    goodCompanions: this.goodCompanions,
                    badCompanions: this.badCompanions,
                    susceptibleTo: this.susceptibleTo,
                    protectsAgainst: this.protectsAgainst,
                    attractsBeneficials: this.attractsBeneficials
                };
            }
            
            static fromJSON(data) {
                const veg = new Vegetable(
                    data.id, 
                    data.nameEN, 
                    data.nameDE, 
                    data.nameIT, 
                    data.nutrition, 
                    data.family,
                    {
                        susceptibleTo: data.susceptibleTo || [],
                        protectsAgainst: data.protectsAgainst || [],
                        attractsBeneficials: data.attractsBeneficials || false
                    }
                );
                veg.goodCompanions = data.goodCompanions || [];
                veg.badCompanions = data.badCompanions || [];
                return veg;
            }
        }
        
        /**
         * Represents a planting in a specific bed and year
         */
        class Planting {
            constructor(bedId, year, vegetableId) {
                this.bedId = bedId;
                this.year = year;
                this.vegetableId = vegetableId;
            }
            
            toJSON() {
                return {
                    bedId: this.bedId,
                    year: this.year,
                    vegetableId: this.vegetableId
                };
            }
            
            static fromJSON(data) {
                return new Planting(data.bedId, data.year, data.vegetableId);
            }
        }
        
        /**
         * Represents a garden bed
         */
        class GardenBed {
            constructor(id, name) {
                this.id = id;
                this.name = name;
            }
            
            // NEW: Get translated name if it's a default name
            getName(lang, bedCount) {
                // Check if this is a default name pattern (e.g., "Bed 1", "Beet 1", "Aiuola 1")
                const defaultPatterns = [
                    /^Bed (\d+)$/,      // English
                    /^Beet (\d+)$/,     // German
                    /^Aiuola (\d+)$/    // Italian
                ];
                
                for (const pattern of defaultPatterns) {
                    const match = this.name.match(pattern);
                    if (match) {
                        const number = match[1];
                        // Return translated default name
                        const translations = {
                            en: `Bed ${number}`,
                            de: `Beet ${number}`,
                            it: `Aiuola ${number}`
                        };
                        return translations[lang] || this.name;
                    }
                }
                
                // Not a default name, return as-is (user-defined)
                return this.name;
            }
            
            toJSON() {
                return {
                    id: this.id,
                    name: this.name
                };
            }
            
            static fromJSON(data) {
                return new GardenBed(data.id, data.name);
            }
        }
        
        /**
         * Manages the entire garden with all its data
         */
        class GardenManager {
            constructor() {
                this.vegetables = new Map();
                this.beds = new Map();
                this.plantings = [];
                this.initializeVegetableDatabase();
            }
            
            initializeVegetableDatabase() {
                // Initialize vegetables with EN, DE, IT names and pest data
                const veggies = [
                    new Vegetable('tomato', 'Tomato', 'Tomate', 'Pomodoro', 'high', 'Solanaceae', {
                        susceptibleTo: ['aphids', 'whitefly', 'hornworms'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('potato', 'Potato', 'Kartoffel', 'Patata', 'high', 'Solanaceae', {
                        susceptibleTo: ['potato-beetle', 'aphids', 'wireworms'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('carrot', 'Carrot', 'Karotte', 'Carota', 'low', 'Apiaceae', {
                        susceptibleTo: ['carrot-fly', 'aphids', 'wireworms'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('lettuce', 'Lettuce', 'Salat', 'Lattuga', 'low', 'Asteraceae', {
                        susceptibleTo: ['slugs', 'aphids', 'leaf-miners'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('cabbage', 'Cabbage', 'Kohl', 'Cavolo', 'high', 'Brassicaceae', {
                        susceptibleTo: ['cabbage-white', 'aphids', 'cabbage-root-fly', 'slugs'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('beans', 'Beans', 'Bohnen', 'Fagioli', 'low', 'Fabaceae', {
                        susceptibleTo: ['aphids', 'bean-beetle', 'slugs'],
                        protectsAgainst: [],
                        attractsBeneficials: true
                    }),
                    new Vegetable('peas', 'Peas', 'Erbsen', 'Piselli', 'low', 'Fabaceae', {
                        susceptibleTo: ['aphids', 'pea-moth', 'slugs'],
                        protectsAgainst: [],
                        attractsBeneficials: true
                    }),
                    new Vegetable('onion', 'Onion', 'Zwiebel', 'Cipolla', 'medium', 'Amaryllidaceae', {
                        susceptibleTo: ['onion-fly', 'thrips'],
                        protectsAgainst: ['carrot-fly', 'aphids', 'slugs'],
                        attractsBeneficials: false
                    }),
                    new Vegetable('garlic', 'Garlic', 'Knoblauch', 'Aglio', 'medium', 'Amaryllidaceae', {
                        susceptibleTo: ['onion-fly'],
                        protectsAgainst: ['aphids', 'slugs', 'japanese-beetle'],
                        attractsBeneficials: false
                    }),
                    new Vegetable('cucumber', 'Cucumber', 'Gurke', 'Cetriolo', 'medium', 'Cucurbitaceae', {
                        susceptibleTo: ['aphids', 'cucumber-beetle', 'spider-mites', 'slugs'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('zucchini', 'Zucchini', 'Zucchini', 'Zucchina', 'medium', 'Cucurbitaceae', {
                        susceptibleTo: ['slugs', 'aphids', 'squash-bug'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('corn', 'Corn', 'Mais', 'Mais', 'high', 'Poaceae', {
                        susceptibleTo: ['corn-borer', 'aphids', 'earworm'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('radish', 'Radish', 'Radieschen', 'Ravanello', 'low', 'Brassicaceae', {
                        susceptibleTo: ['flea-beetle', 'aphids', 'root-maggot'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('spinach', 'Spinach', 'Spinat', 'Spinaci', 'medium', 'Amaranthaceae', {
                        susceptibleTo: ['aphids', 'leaf-miners', 'slugs'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('basil', 'Basil', 'Basilikum', 'Basilico', 'low', 'Lamiaceae', {
                        susceptibleTo: ['aphids', 'japanese-beetle', 'slugs'],
                        protectsAgainst: ['aphids', 'whitefly', 'hornworms'],
                        attractsBeneficials: true
                    }),
                    new Vegetable('pepper', 'Pepper', 'Paprika', 'Peperone', 'medium', 'Solanaceae', {
                        susceptibleTo: ['aphids', 'spider-mites', 'hornworms'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('celery', 'Celery', 'Sellerie', 'Sedano', 'high', 'Apiaceae', {
                        susceptibleTo: ['aphids', 'carrot-fly', 'leaf-miners'],
                        protectsAgainst: ['cabbage-white'],
                        attractsBeneficials: false
                    }),
                    new Vegetable('arugula', 'Arugula', 'Rucola', 'Rucola', 'low', 'Brassicaceae', {
                        susceptibleTo: ['flea-beetle', 'slugs', 'aphids'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('kohlrabi', 'Kohlrabi', 'Kohlrabi', 'Cavolo Rapa', 'medium', 'Brassicaceae', {
                        susceptibleTo: ['cabbage-white', 'aphids', 'flea-beetle', 'slugs'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('leek', 'Leek', 'Lauch', 'Porro', 'medium', 'Amaryllidaceae', {
                        susceptibleTo: ['leek-moth', 'thrips', 'onion-fly'],
                        protectsAgainst: ['carrot-fly'],
                        attractsBeneficials: false
                    }),
                    new Vegetable('broccoli', 'Broccoli', 'Brokkoli', 'Broccoli', 'high', 'Brassicaceae', {
                        susceptibleTo: ['cabbage-white', 'aphids', 'cabbage-root-fly', 'slugs'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('chives', 'Chives', 'Schnittlauch', 'Erba Cipollina', 'low', 'Amaryllidaceae', {
                        susceptibleTo: [],
                        protectsAgainst: ['aphids', 'carrot-fly', 'japanese-beetle', 'slugs'],
                        attractsBeneficials: true
                    }),
                    new Vegetable('parsley', 'Parsley', 'Petersilie', 'Prezzemolo', 'low', 'Apiaceae', {
                        susceptibleTo: ['aphids', 'carrot-fly'],
                        protectsAgainst: [],
                        attractsBeneficials: true
                    }),
                    new Vegetable('pumpkin', 'Pumpkin', 'K√ºrbis', 'Zucca', 'high', 'Cucurbitaceae', {
                        susceptibleTo: ['squash-bug', 'aphids', 'cucumber-beetle', 'slugs'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('mint', 'Mint', 'Minze', 'Menta', 'low', 'Lamiaceae', {
                        susceptibleTo: ['aphids', 'spider-mites'],
                        protectsAgainst: ['aphids', 'cabbage-white', 'flea-beetle', 'slugs'],
                        attractsBeneficials: true
                    }),
                    new Vegetable('strawberry', 'Strawberry', 'Erdbeere', 'Fragola', 'medium', 'Rosaceae', {
                        susceptibleTo: ['slugs', 'aphids', 'spider-mites'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('turnip', 'Turnip', 'Rettich', 'Ravanello Bianco', 'low', 'Brassicaceae', {
                        susceptibleTo: ['flea-beetle', 'aphids', 'root-maggot'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('rhubarb', 'Rhubarb', 'Rhabarber', 'Rabarbaro', 'medium', 'Polygonaceae', {
                        susceptibleTo: ['aphids', 'slugs'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('eggplant', 'Eggplant', 'Aubergine', 'Melanzana', 'high', 'Solanaceae', {
                        susceptibleTo: ['aphids', 'flea-beetle', 'potato-beetle'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('fennel', 'Fennel', 'Fenchel', 'Finocchio', 'medium', 'Apiaceae', {
                        susceptibleTo: ['aphids'],
                        protectsAgainst: ['aphids', 'slugs'],
                        attractsBeneficials: true
                    }),
                    new Vegetable('chili', 'Chili Pepper', 'Chili', 'Peperoncino', 'high', 'Solanaceae', {
                        susceptibleTo: ['aphids', 'whitefly', 'spider-mites'],
                        protectsAgainst: ['aphids', 'beetles', 'slugs'],
                        attractsBeneficials: false
                    }),
                    new Vegetable('parsnip', 'Parsnip', 'Pastinake', 'Pastinaca', 'low', 'Apiaceae', {
                        susceptibleTo: ['carrot-fly', 'aphids', 'slugs'],
                        protectsAgainst: [],
                        attractsBeneficials: false
                    }),
                    new Vegetable('rosemary', 'Rosemary', 'Rosmarin', 'Rosmarino', 'low', 'Lamiaceae', {
                        susceptibleTo: ['spider-mites'],
                        protectsAgainst: ['cabbage-white', 'carrot-fly', 'bean-beetle', 'slugs'],
                        attractsBeneficials: true
                    }),
                    new Vegetable('oregano', 'Oregano', 'Oregano', 'Origano', 'low', 'Lamiaceae', {
                        susceptibleTo: ['aphids', 'spider-mites'],
                        protectsAgainst: ['aphids', 'cabbage-white', 'cucumber-beetle'],
                        attractsBeneficials: true
                    }),
                    new Vegetable('sage', 'Sage', 'Salbei', 'Salvia', 'low', 'Lamiaceae', {
                        susceptibleTo: ['slugs', 'spider-mites'],
                        protectsAgainst: ['cabbage-white', 'carrot-fly', 'slugs', 'flea-beetle'],
                        attractsBeneficials: true
                    }),
                ];
                
                veggies.forEach(v => this.vegetables.set(v.id, v));
                
                // Set up companion planting relationships
                this.setCompanions('tomato', ['basil', 'carrot', 'lettuce', 'celery'], ['potato', 'cabbage', 'peas']);
                this.setCompanions('potato', ['beans', 'corn', 'cabbage'], ['tomato', 'cucumber', 'pepper']);
                this.setCompanions('carrot', ['tomato', 'lettuce', 'onion', 'leek'], ['celery']);
                this.setCompanions('lettuce', ['carrot', 'radish', 'kohlrabi'], ['celery']);
                this.setCompanions('cabbage', ['beans', 'potato', 'celery'], ['tomato', 'onion', 'garlic']);
                this.setCompanions('beans', ['corn', 'cabbage', 'potato', 'cucumber'], ['onion', 'garlic', 'leek']);
                this.setCompanions('peas', ['carrot', 'radish', 'kohlrabi'], ['onion', 'garlic', 'leek', 'tomato']);
                this.setCompanions('onion', ['carrot', 'lettuce', 'tomato'], ['beans', 'peas', 'cabbage']);
                this.setCompanions('garlic', ['tomato', 'cucumber'], ['beans', 'peas', 'cabbage']);
                this.setCompanions('cucumber', ['beans', 'corn', 'peas', 'garlic'], ['potato', 'radish']);
                this.setCompanions('zucchini', ['beans', 'corn', 'onion'], ['potato']);
                this.setCompanions('corn', ['beans', 'cucumber', 'peas', 'zucchini'], ['tomato', 'celery']);
                this.setCompanions('radish', ['lettuce', 'peas', 'carrot'], ['cucumber']);
                this.setCompanions('spinach', ['peas', 'kohlrabi', 'radish'], []);
                this.setCompanions('basil', ['tomato', 'pepper', 'cucumber'], []);
                this.setCompanions('pepper', ['basil', 'onion', 'carrot'], ['beans', 'potato']);
                this.setCompanions('celery', ['cabbage', 'leek', 'tomato'], ['carrot', 'lettuce', 'corn']);
                this.setCompanions('arugula', ['beans', 'peas', 'radish'], []);
                this.setCompanions('kohlrabi', ['lettuce', 'peas', 'spinach'], []);
                this.setCompanions('leek', ['celery', 'carrot', 'tomato'], ['beans', 'peas']);
                
                // New vegetables
                this.setCompanions('broccoli', ['beans', 'celery', 'onion', 'potato'], ['tomato', 'strawberry', 'pepper']);
                this.setCompanions('chives', ['carrot', 'tomato', 'strawberry'], ['beans', 'peas']);
                this.setCompanions('parsley', ['tomato', 'carrot', 'corn'], ['lettuce']);
                this.setCompanions('pumpkin', ['corn', 'beans', 'peas'], ['potato']);
                this.setCompanions('mint', ['cabbage', 'tomato'], ['parsley']);
                this.setCompanions('strawberry', ['beans', 'lettuce', 'spinach', 'chives'], ['cabbage', 'broccoli']);
                this.setCompanions('turnip', ['peas', 'beans', 'mint'], []);
                this.setCompanions('rhubarb', ['beans', 'cabbage', 'onion'], []);
                this.setCompanions('eggplant', ['beans', 'pepper', 'spinach'], ['potato', 'fennel']);
                this.setCompanions('fennel', ['celery'], ['tomato', 'beans', 'kohlrabi', 'eggplant']);
                
                // Newest additions (2025)
                this.setCompanions('chili', ['basil', 'oregano', 'onion', 'carrot'], ['beans', 'kohlrabi']);
                this.setCompanions('parsnip', ['onion', 'lettuce', 'rosemary', 'sage'], ['carrot', 'celery', 'parsley']);
                this.setCompanions('rosemary', ['cabbage', 'beans', 'carrot', 'sage', 'parsnip'], ['cucumber', 'potato']);
                this.setCompanions('oregano', ['cabbage', 'cucumber', 'beans', 'chili'], ['fennel']);
                this.setCompanions('sage', ['cabbage', 'carrot', 'rosemary', 'parsnip', 'tomato'], ['cucumber', 'onion']);
            }
            
            setCompanions(vegId, good, bad) {
                const veg = this.vegetables.get(vegId);
                if (!veg) return;
                
                good.forEach(g => {
                    if (this.vegetables.has(g)) {
                        veg.addGoodCompanion(g);
                    }
                });
                
                bad.forEach(b => {
                    if (this.vegetables.has(b)) {
                        veg.addBadCompanion(b);
                    }
                });
            }
            
            addBed(name) {
                const id = Date.now();
                const bed = new GardenBed(id, name || `Bed ${this.beds.size + 1}`);
                this.beds.set(id, bed);
                return bed;
            }
            
            removeBed(bedId) {
                this.beds.delete(bedId);
                this.plantings = this.plantings.filter(p => p.bedId !== bedId);
            }
            
            addPlanting(bedId, year, vegetableId) {
                this.plantings = this.plantings.filter(
                    p => !(p.bedId === bedId && p.year === year && p.vegetableId === vegetableId)
                );
                this.plantings.push(new Planting(bedId, year, vegetableId));
            }
            
            removePlanting(bedId, year, vegetableId) {
                this.plantings = this.plantings.filter(
                    p => !(p.bedId === bedId && p.year === year && p.vegetableId === vegetableId)
                );
            }
            
            getPlantingsForBed(bedId, year) {
                return this.plantings
                    .filter(p => p.bedId === bedId && p.year === year)
                    .map(p => this.vegetables.get(p.vegetableId))
                    .filter(v => v);
            }
            
            getPlantingIdsForBed(bedId, year) {
                return this.plantings
                    .filter(p => p.bedId === bedId && p.year === year)
                    .map(p => p.vegetableId);
            }
            
            exportData() {
                return JSON.stringify({
                    version: '1.2',  // NEW: Data format version
                    vegetables: Array.from(this.vegetables.values()).map(v => v.toJSON()),
                    beds: Array.from(this.beds.values()).map(b => b.toJSON()),
                    plantings: this.plantings.map(p => p.toJSON())
                }, null, 2);
            }
            
            // NEW: Migrate old data formats to current version
            migrateData(data) {
                const currentVersion = '1.2';
                const dataVersion = data.version || '1.0';
                
                console.log(`Migrating data from v${dataVersion} to v${currentVersion}`);
                
                // No version = v1.0 (before pest protection)
                if (!data.version || data.version === '1.0') {
                    console.log('Migrating from v1.0: Adding pest data to vegetables');
                    
                    // Add pest data to all vegetables
                    if (data.vegetables) {
                        data.vegetables = data.vegetables.map(veg => {
                            // If vegetable doesn't have pest data, add empty arrays
                            if (!veg.susceptibleTo) veg.susceptibleTo = [];
                            if (!veg.protectsAgainst) veg.protectsAgainst = [];
                            if (veg.attractsBeneficials === undefined) veg.attractsBeneficials = false;
                            return veg;
                        });
                    }
                    
                    data.version = '1.1';
                }
                
                // v1.1 to v1.2 (if needed in future)
                if (data.version === '1.1') {
                    console.log('Migrating from v1.1 to v1.2');
                    // Future migrations here
                    data.version = '1.2';
                }
                
                return data;
            }
            
            importData(jsonString) {
                try {
                    let data = JSON.parse(jsonString);
                    
                    // NEW: Migrate old data format
                    data = this.migrateData(data);
                    
                    this.vegetables.clear();
                    data.vegetables.forEach(v => {
                        const veg = Vegetable.fromJSON(v);
                        this.vegetables.set(veg.id, veg);
                    });
                    
                    this.beds.clear();
                    data.beds.forEach(b => {
                        const bed = GardenBed.fromJSON(b);
                        this.beds.set(bed.id, bed);
                    });
                    
                    this.plantings = data.plantings.map(p => Planting.fromJSON(p));
                    
                    console.log(`Data successfully imported (version ${data.version})`);
                    return true;
                } catch (e) {
                    console.error('Import failed:', e);
                    return false;
                }
            }
            
            saveToLocalStorage() {
                localStorage.setItem('beetAnythingData', this.exportData());
            }
            
            loadFromLocalStorage() {
                const data = localStorage.getItem('beetAnythingData');
                if (data) {
                    return this.importData(data);
                }
                return false;
            }
        }
        
        // ============================================
        // SUGGESTION ALGORITHM
        // ============================================
        
        class SuggestionEngine {
            constructor(gardenManager) {
                this.garden = gardenManager;
            }
            
            generateSuggestions(wishlist, currentYear) {
                const suggestions = [];
                const beds = Array.from(this.garden.beds.values());
                const usedVeggies = new Set();
                
                const bedScores = [];
                
                for (const bed of beds) {
                    for (const vegId of wishlist) {
                        if (usedVeggies.has(vegId)) continue;
                        
                        const score = this.scorePlantingOption(bed.id, vegId, currentYear);
                        bedScores.push({
                            bedId: bed.id,
                            bedName: bed.name,
                            vegId: vegId,
                            score: score.total,
                            reasons: score.reasons
                        });
                    }
                }
                
                bedScores.sort((a, b) => b.score - a.score);
                
                const assignedBeds = new Set();
                
                for (const option of bedScores) {
                    if (usedVeggies.has(option.vegId) || assignedBeds.has(option.bedId)) {
                        continue;
                    }
                    
                    suggestions.push({
                        bedId: option.bedId,
                        bedName: option.bedName,
                        vegId: option.vegId,
                        vegetableName: this.garden.vegetables.get(option.vegId).getName(app.currentLanguage),
                        score: option.score,
                        reasons: option.reasons
                    });
                    
                    usedVeggies.add(option.vegId);
                    assignedBeds.add(option.bedId);
                }
                
                return suggestions;
            }
            
            scorePlantingOption(bedId, vegId, year) {
                const veg = this.garden.vegetables.get(vegId);
                if (!veg) return { total: 0, reasons: [] };
                
                let score = 0;
                const reasons = [];
                
                const prevYear = this.garden.getPlantingIdsForBed(bedId, year - 1);
                const currentYear = this.garden.getPlantingIdsForBed(bedId, year);
                
                // Rule 1: Family rotation
                const prevFamilies = prevYear.map(id => this.garden.vegetables.get(id)?.family).filter(f => f);
                if (!prevFamilies.includes(veg.family)) {
                    score += 30;
                    reasons.push('reason.differentFamily');
                } else {
                    score -= 20;
                    reasons.push('reason.sameFamily');
                }
                
                // Rule 2: Nutrition rotation
                const prevNutrition = prevYear.map(id => this.garden.vegetables.get(id)?.nutrition).filter(n => n);
                if (prevNutrition.includes('high') && veg.nutrition === 'low') {
                    score += 25;
                    reasons.push('reason.restoresSoil');
                } else if (prevNutrition.includes('high') && veg.nutrition === 'high') {
                    score -= 15;
                    reasons.push('reason.heavyAfterHeavy');
                } else if (veg.nutrition === 'low') {
                    score += 10;
                    reasons.push('reason.lowNutrient');
                }
                
                // Rule 3: Companion planting
                for (const currentVegId of currentYear) {
                    const compatibility = veg.isCompatibleWith(currentVegId);
                    if (compatibility === 1) {
                        score += 15;
                        reasons.push(`reason.goodCompanion:${currentVegId}`);
                    } else if (compatibility === -1) {
                        score -= 30;
                        reasons.push(`reason.badCompanion:${currentVegId}`);
                    }
                }
                
                // Rule 4: Prefer empty beds
                if (currentYear.length === 0) {
                    score += 5;
                }
                
                // Rule 5: Two-year rotation
                const twoYearsAgo = this.garden.getPlantingIdsForBed(bedId, year - 2);
                if (twoYearsAgo.includes(vegId)) {
                    score -= 10;
                    reasons.push('reason.samePlant2Years');
                }
                
                // Rule 6: Pest protection (NEW!)
                const currentPlantings = this.garden.getPlantingsForBed(bedId, year);
                for (const otherVeg of currentPlantings) {
                    // Positive: This plant protects others from pests
                    if (veg.protectsPlant(otherVeg)) {
                        score += 20;
                        reasons.push(`reason.pestProtection:${otherVeg.id}`);
                    }
                    
                    // Negative: Plants share pest vulnerabilities
                    const sharedPests = veg.sharesVulnerabilitiesWith(otherVeg);
                    if (sharedPests.length > 0) {
                        score -= 15;
                        reasons.push(`reason.sharedPestRisk:${otherVeg.id}`);
                    }
                }
                
                // Rule 7: Attracts beneficial insects (NEW!)
                if (veg.attractsBeneficials && currentPlantings.length > 0) {
                    score += 10;
                    reasons.push('reason.attractsBeneficials');
                }
                
                return { total: score, reasons };
            }
        }
        
        // ============================================
        // APPLICATION CONTROLLER
        // ============================================
        
        const app = {
            garden: new GardenManager(),
            suggestionEngine: null,
            currentYear: 2024,
            wishlist: [],
            currentLanguage: 'en',
            optimizer: {
                selectedPlants: [],
                mode: 'fresh',
                maxPlantsPerBed: 4,
                numBeds: 'auto',
                proposedLayout: null,
                score: null
            },
            
            init() {
                // Try to load saved data
                const loaded = this.garden.loadFromLocalStorage();
                
                // Log data version info
                if (loaded) {
                    const data = localStorage.getItem('beetAnythingData');
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            console.log(`‚úÖ Loaded data version: ${parsed.version || '1.0 (legacy)'}`);
                        } catch (e) {
                            console.log('Could not parse data version');
                        }
                    }
                }
                
                // Load app state
                const state = localStorage.getItem('beetAnythingState');
                if (state) {
                    try {
                        const parsedState = JSON.parse(state);
                        this.currentYear = parsedState.currentYear || 2024;
                        this.wishlist = parsedState.wishlist || [];
                        this.currentLanguage = parsedState.language || 'en';
                        
                        document.getElementById('yearDisplay').textContent = this.currentYear;
                        document.getElementById('yearDisplayBeds').textContent = this.currentYear;
                    } catch (e) {
                        console.log('State could not be loaded:', e);
                    }
                }
                
                // If no saved data, initialize with default beds
                if (!loaded) {
                    console.log('üÜï No saved data found - initializing fresh garden');
                    for (let i = 0; i < 4; i++) {
                        this.garden.addBed(`Bed ${i + 1}`);
                    }
                    this.save();
                }
                
                this.suggestionEngine = new SuggestionEngine(this.garden);
                
                // Populate vegetable select
                this.populateVegetableSelect();
                
                // Set language
                this.setLanguage(this.currentLanguage, false);
                
                this.render();
            },
            
            setLanguage(lang, save = true) {
                this.currentLanguage = lang;
                
                // Update language switch buttons
                document.querySelectorAll('.language-switch button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(`lang${lang.toUpperCase()}`).classList.add('active');
                
                // Update all translatable elements
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[lang][key]) {
                        el.textContent = translations[lang][key];
                    }
                });
                
                // Re-populate vegetable select with translated names
                this.populateVegetableSelect();
                
                // Re-render to update vegetable names
                this.render();
                
                if (save) {
                    this.save();
                }
            },
            
            t(key, replacements = {}) {
                let text = translations[this.currentLanguage][key] || key;
                
                // Handle replacements like {name}
                Object.keys(replacements).forEach(replaceKey => {
                    text = text.replace(`{${replaceKey}}`, replacements[replaceKey]);
                });
                
                return text;
            },
            
            populateVegetableSelect() {
                const select = document.getElementById('vegetableSelect');
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = `<option value="">${this.t('wishlist.select')}</option>`;
                
                const sortedVeggies = Array.from(this.garden.vegetables.values())
                    .sort((a, b) => a.getName(this.currentLanguage).localeCompare(b.getName(this.currentLanguage)));
                
                sortedVeggies.forEach(veg => {
                    const option = document.createElement('option');
                    option.value = veg.id;
                    option.textContent = veg.getName(this.currentLanguage);
                    select.appendChild(option);
                });
                
                if (currentValue) select.value = currentValue;
            },
            
            changeYear(delta) {
                this.currentYear += delta;
                document.getElementById('yearDisplay').textContent = this.currentYear;
                document.getElementById('yearDisplayBeds').textContent = this.currentYear;
                this.save();
                this.render();
            },
            
            addToWishlist() {
                const select = document.getElementById('vegetableSelect');
                if (!select) return;
                
                const vegId = select.value;
                if (vegId && !this.wishlist.includes(vegId)) {
                    this.wishlist.push(vegId);
                    select.value = '';
                    this.save();
                    this.renderWishlist();
                }
            },
            
            // ===== ROTATION WIZARD =====
            showRotationWizard() {
                const currentCalendarYear = new Date().getFullYear();
                
                if (this.currentYear === currentCalendarYear) {
                    alert(this.t('wizard.sameYear'));
                    return;
                }
                
                const previousYear = this.currentYear - 1;
                const prevPlants = new Set();
                
                this.garden.beds.forEach(bed => {
                    const plantings = this.garden.getPlantingsForBed(bed.id, previousYear);
                    plantings.forEach(p => prevPlants.add(p.id));
                });
                
                if (prevPlants.size === 0) {
                    alert(this.t('wizard.noPrevious'));
                    return;
                }
                
                this.optimizer.selectedPlants = Array.from(prevPlants);
                this.optimizer.mode = 'fit';
                this.optimizer.maxPlantsPerBed = 4;
                this.optimizer.numBeds = this.garden.beds.size;
                
                const result = this.optimizeLayout();
                this.displayRotationWizardResults(result, previousYear);
            },
            
            displayRotationWizardResults(result, previousYear) {
                const scorePercent = Math.max(0, Math.min(100, 50 + result.score));
                let scoreLabel = this.t('optimizer.poor');
                if (scorePercent >= 80) scoreLabel = this.t('optimizer.excellent');
                else if (scorePercent >= 70) scoreLabel = this.t('optimizer.veryGood');
                else if (scorePercent >= 60) scoreLabel = this.t('optimizer.good');
                else if (scorePercent >= 50) scoreLabel = this.t('optimizer.fair');
                
                let html = `
                    <div class="optimization-result">
                        <h3>${this.t('wizard.title')}</h3>
                        <div class="result-score">
                            ${this.t('optimizer.score')} ${Math.round(scorePercent)}/100 (${scoreLabel})
                        </div>
                `;
                
                result.beds.forEach((bed, idx) => {
                    const bedNum = idx + 1;
                    const bedName = `${this.t('optimizer.bed')} ${bedNum}`;
                    
                    let wasPlants = '';
                    if (this.garden.beds.has(bedNum)) {
                        const prevPlants = this.garden.getPlantingsForBed(bedNum, previousYear);
                        wasPlants = prevPlants.map(p => p.getName(this.currentLanguage)).join(', ') || this.t('bed.empty');
                    }
                    
                    const nowPlants = bed.map(p => p.getName(this.currentLanguage)).join(', ');
                    
                    html += `
                        <div class="proposed-bed">
                            <strong>${bedName}</strong>
                            <div class="bed-comparison">
                                <div><small>${previousYear}:</small> ${wasPlants}</div>
                                <div class="bed-comparison-arrow">‚Üí</div>
                                <div><small>${this.currentYear}:</small> ${nowPlants}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        <div style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem;">
                            <button class="btn btn-primary" onclick="app.applyRotationWizard()" style="width: 100%;">
                                ${this.t('wizard.apply')}
                            </button>
                            <button class="btn btn-secondary" onclick="app.closeRotationWizard()" style="width: 100%;">
                                ${this.t('wizard.cancel')}
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('suggestionsBox').innerHTML = html;
                this.rotationWizardResult = result.beds;
            },
            
            applyRotationWizard() {
                if (!this.rotationWizardResult) return;
                
                this.garden.plantings = this.garden.plantings.filter(p => p.year !== this.currentYear);
                this.garden.beds.clear();
                
                this.rotationWizardResult.forEach((bed, idx) => {
                    const newBed = this.garden.addBed();
                    bed.forEach(plant => {
                        this.garden.assignToBed(plant.id, newBed.id, this.currentYear);
                    });
                });
                
                this.save();
                this.render();
                
                alert(this.t('wizard.applied'));
                this.closeRotationWizard();
            },
            
            closeRotationWizard() {
                document.getElementById('suggestionsBox').innerHTML = '';
                this.rotationWizardResult = null;
            },
            
            removeFromWishlist(vegId) {
                this.wishlist = this.wishlist.filter(v => v !== vegId);
                this.save();
                this.renderWishlist();
            },
            
            renderWishlist() {
                const container = document.getElementById('wishlistItems');
                if (this.wishlist.length === 0) {
                    container.innerHTML = `<p style="color: var(--soil-medium); font-style: italic;">${this.t('wishlist.empty')}</p>`;
                    return;
                }
                
                container.innerHTML = this.wishlist.map(vegId => {
                    const veg = this.garden.vegetables.get(vegId);
                    if (!veg) return '';
                    return `
                        <div class="wishlist-tag">
                            ${veg.getName(this.currentLanguage)}
                            <button onclick="app.removeFromWishlist('${vegId}')">√ó</button>
                        </div>
                    `;
                }).join('');
            },
            
            addBed() {
                this.garden.addBed();
                this.save();
                this.render();
            },
            
            removeBed(bedId) {
                if (confirm(this.t('bed.remove'))) {
                    this.garden.removeBed(bedId);
                    this.save();
                    this.render();
                }
            },
            
            openBedModal(bedId) {
                const bed = this.garden.beds.get(bedId);
                if (!bed) return;
                
                const modal = document.getElementById('bedModal');
                const modalBody = document.getElementById('modalBody');
                
                modalBody.innerHTML = `
                    <div class="form-group">
                        <label>${this.t('modal.bedName')}</label>
                        <input type="text" id="bedNameInput" value="${bed.name}" style="width: 100%;">
                    </div>
                    <div class="form-group">
                        <label>${this.t('modal.assignPlantsFor')} ${this.currentYear}</label>
                        <select id="plantSelect" style="width: 100%;">
                            <option value="">${this.t('modal.selectPlant')}</option>
                            ${Array.from(this.garden.vegetables.values())
                                .sort((a, b) => a.getName(this.currentLanguage).localeCompare(b.getName(this.currentLanguage)))
                                .map(veg => `<option value="${veg.id}">${veg.getName(this.currentLanguage)}</option>`)
                                .join('')}
                        </select>
                        <button class="btn btn-primary" style="margin-top: 0.5rem;" onclick="app.addPlantToBed(${bedId})">${this.t('modal.addPlant')}</button>
                    </div>
                    <div id="bedPlantsList">
                        ${this.renderBedPlantsList(bedId)}
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="app.saveBed(${bedId})">${this.t('modal.save')}</button>
                `;
                
                modal.classList.add('active');
            },
            
            renderBedPlantsList(bedId) {
                const vegIds = this.garden.getPlantingIdsForBed(bedId, this.currentYear);
                
                if (vegIds.length === 0) {
                    return `<p style="color: var(--soil-medium); font-style: italic; margin-top: 1rem;">${this.t('modal.noPlants')}</p>`;
                }
                
                return `
                    <div style="margin-top: 1rem;">
                        <strong>${this.t('modal.currentPlants')} (${this.currentYear}):</strong>
                        ${vegIds.map(vegId => {
                            const veg = this.garden.vegetables.get(vegId);
                            if (!veg) return '';
                            return `
                                <div style="background: var(--cream); padding: 0.75rem; margin: 0.5rem 0; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                                    <span>${veg.getName(this.currentLanguage)} <span style="font-size: 0.8rem; color: var(--soil-medium);">(${veg.family})</span></span>
                                    <button onclick="app.removePlantFromBed(${bedId}, '${vegId}')" style="background: var(--terracotta); color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer;">${this.t('modal.remove')}</button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },
            
            addPlantToBed(bedId) {
                const select = document.getElementById('plantSelect');
                const vegId = select.value;
                if (!vegId) return;
                
                this.garden.addPlanting(bedId, this.currentYear, vegId);
                select.value = '';
                
                const modalBody = document.getElementById('modalBody');
                modalBody.querySelector('#bedPlantsList').innerHTML = this.renderBedPlantsList(bedId);
                
                this.save();
            },
            
            removePlantFromBed(bedId, vegId) {
                this.garden.removePlanting(bedId, this.currentYear, vegId);
                
                const modalBody = document.getElementById('modalBody');
                modalBody.querySelector('#bedPlantsList').innerHTML = this.renderBedPlantsList(bedId);
                
                this.save();
            },
            
            saveBed(bedId) {
                const bed = this.garden.beds.get(bedId);
                const nameInput = document.getElementById('bedNameInput');
                bed.name = nameInput.value;
                this.closeModal();
                this.save();
                this.render();
            },
            
            closeModal() {
                document.getElementById('bedModal').classList.remove('active');
            },
            
            generateSuggestions() {
                if (this.wishlist.length === 0) {
                    alert(this.t('wishlist.empty'));
                    return;
                }
                
                const suggestions = this.suggestionEngine.generateSuggestions(this.wishlist, this.currentYear);
                this.renderSuggestions(suggestions);
            },
            
            renderSuggestions(suggestions) {
                const container = document.getElementById('suggestionsBox');
                
                if (suggestions.length === 0) {
                    container.innerHTML = `
                        <div class="suggestion-box">
                            <h4>${this.t('suggestions.none')}</h4>
                            <p>${this.t('suggestions.noneText')}</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div class="suggestion-box">
                        <h4>${this.t('suggestions.title')}</h4>
                        ${suggestions.map(s => `
                            <div class="suggestion-item">
                                <strong>${s.bedName}:</strong> ${s.vegetableName}<br>
                                <small style="color: var(--soil-medium); display: block; margin: 0.5rem 0;">
                                    ${s.reasons.slice(0, 2).map(r => this.translateReason(r)).join(' ‚Ä¢ ')}
                                </small>
                                <button class="btn btn-primary" style="margin-top: 0.5rem; padding: 0.5rem 1rem; font-size: 0.85rem;" 
                                        onclick="app.applySuggestion(${s.bedId}, '${s.vegId}')">
                                    ${this.t('suggestions.apply')}
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            },
            
            translateReason(reason) {
                if (reason.includes(':')) {
                    const [key, vegId] = reason.split(':');
                    const veg = this.garden.vegetables.get(vegId);
                    if (veg) {
                        return `${this.t(key)} ${veg.getName(this.currentLanguage)}`;
                    }
                }
                return this.t(reason);
            },
            
            applySuggestion(bedId, vegId) {
                this.garden.addPlanting(bedId, this.currentYear, vegId);
                this.save();
                this.render();
            },
            
            showMatrix() {
                const modal = document.getElementById('matrixModal');
                const body = document.getElementById('matrixBody');
                
                const veggies = Array.from(this.garden.vegetables.values())
                    .sort((a, b) => a.getName(this.currentLanguage).localeCompare(b.getName(this.currentLanguage)));
                
                let html = `
                    <div class="compatibility-matrix">
                        <table class="compatibility-table">
                            <thead>
                                <tr>
                                    <th>Plant</th>
                                    ${veggies.map(v => `<th>${v.getName(this.currentLanguage)}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                veggies.forEach(rowVeg => {
                    html += `<tr><th>${rowVeg.getName(this.currentLanguage)}</th>`;
                    veggies.forEach(colVeg => {
                        if (rowVeg.id === colVeg.id) {
                            html += '<td class="compat-neutral">-</td>';
                        } else {
                            const compat = rowVeg.isCompatibleWith(colVeg.id);
                            if (compat === 1) {
                                html += '<td class="compat-good">‚úì</td>';
                            } else if (compat === -1) {
                                html += '<td class="compat-bad">‚úó</td>';
                            } else {
                                html += '<td class="compat-neutral">‚óã</td>';
                            }
                        }
                    });
                    html += '</tr>';
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 1rem; font-size: 0.9rem;">
                        <strong>${this.t('matrix.legend')}:</strong> ‚úì = ${this.t('matrix.good')} | ‚úó = ${this.t('matrix.bad')} | ‚óã = ${this.t('matrix.neutral')}
                    </div>
                `;
                
                body.innerHTML = html;
                modal.classList.add('active');
            },
            
            closeMatrixModal() {
                document.getElementById('matrixModal').classList.remove('active');
            },
            
            exportData() {
                const data = this.garden.exportData();
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${this.t('export.filename')}-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },
            
            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const success = this.garden.importData(event.target.result);
                        if (success) {
                            alert(this.t('import.success'));
                            this.save();
                            this.render();
                        } else {
                            alert(this.t('import.error'));
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },
            
            clearAllData() {
                // Step 1: Confirm deletion intent
                const wantToDelete = confirm(this.t('data.clearConfirm'));
                if (!wantToDelete) {
                    return; // User cancelled - back to normal
                }
                
                // Step 2: Offer backup
                const wantBackup = confirm(this.t('data.offerBackup'));
                
                if (wantBackup) {
                    // Create backup first
                    this.exportData();
                    alert(this.t('data.backupSaved'));
                    // Then delete after short delay
                    setTimeout(() => {
                        this.performClearAllData();
                    }, 500);
                } else {
                    // Delete without backup
                    this.performClearAllData();
                }
            },
            
            performClearAllData() {
                // Clear localStorage
                localStorage.removeItem('beetAnythingData');
                localStorage.removeItem('beetAnythingState');
                
                // Show confirmation
                alert(this.t('data.cleared'));
                
                // Reload page to start fresh
                window.location.reload();
            },
            
            installAsApp() {
                // Check if already running as PWA
                if (window.matchMedia('(display-mode: standalone)').matches) {
                    alert(this.t('install.alreadyInstalled'));
                    return;
                }
                
                // Try PWA installation
                if (window.deferredPrompt) {
                    window.deferredPrompt.prompt();
                    window.deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('App was installed');
                        }
                        window.deferredPrompt = null;
                        document.getElementById('headerInstallButton').style.display = 'none';
                    });
                } else {
                    // Fallback: Show manual installation instructions
                    this.showInstallationInstructions();
                }
            },
            
            showInstallationInstructions() {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isAndroid = /Android/.test(navigator.userAgent);
                
                let instructions = '';
                
                if (isIOS) {
                    instructions = this.t('install.iosTitle') + '\n\n' + this.t('install.iosSteps');
                } else if (isAndroid) {
                    instructions = this.t('install.androidTitle') + '\n\n' + this.t('install.androidSteps');
                } else {
                    instructions = this.t('install.desktopTitle') + '\n\n' + this.t('install.desktopSteps');
                }
                
                alert(instructions);
            },
            
            save() {
                this.garden.saveToLocalStorage();
                localStorage.setItem('beetAnythingState', JSON.stringify({
                    currentYear: this.currentYear,
                    wishlist: this.wishlist,
                    language: this.currentLanguage
                }));
            },
            
            render() {
                const grid = document.getElementById('gardenGrid');
                const beds = Array.from(this.garden.beds.values());
                
                if (beds.length === 0) {
                    grid.innerHTML = `<p class="empty-bed">${this.t('bed.empty')}</p>`;
                    return;
                }
                
                grid.innerHTML = beds.map(bed => {
                    const currentPlantings = this.garden.getPlantingsForBed(bed.id, this.currentYear);
                    const prevPlantings = this.garden.getPlantingsForBed(bed.id, this.currentYear - 1);
                    
                    let content = '';
                    if (currentPlantings.length === 0) {
                        content = `<div class="empty-bed" onclick="app.openBedModal(${bed.id})">${this.t('bed.empty')}</div>`;
                    } else {
                        content = currentPlantings.map(veg => {
                            const currentIds = currentPlantings.map(v => v.id);
                            const goodCompanions = currentIds.filter(id => id !== veg.id && veg.isCompatibleWith(id) === 1);
                            const badCompanions = currentIds.filter(id => id !== veg.id && veg.isCompatibleWith(id) === -1);
                            
                            // NEW: Find plants that this vegetable protects
                            const protectedPlants = currentPlantings.filter(other => 
                                other.id !== veg.id && veg.protectsPlant(other)
                            );
                            
                            // NEW: Find plants with shared pests
                            const sharedPestPlants = currentPlantings.filter(other =>
                                other.id !== veg.id && veg.sharesVulnerabilitiesWith(other).length > 0
                            );
                            
                            return `
                                <div class="plant-assignment">
                                    <div class="plant-name">${veg.getName(this.currentLanguage)}</div>
                                    <div class="plant-meta">
                                        <span class="nutrition-badge nutrition-${veg.nutrition}">
                                            ${this.t(`nutrition.${veg.nutrition}`)}
                                        </span>
                                        <span>${veg.family}</span>
                                        ${(() => {
                                            let iconsHTML = '';
                                            // Beneficial insects
                                            if (veg.attractsBeneficials) {
                                                iconsHTML += `<span class="pest-icon" title="${this.t('tooltip.beneficials')}" style="margin-left: 0.25rem;">üêû</span>`;
                                            }
                                            // Pest vulnerabilities
                                            const pestIcons = veg.getPestIcons();
                                            const pestsByCategory = veg.getPestsByCategory();
                                            
                                            if (pestIcons.slugs) {
                                                const tooltip = this.t('tooltip.slugs');
                                                iconsHTML += `<span class="pest-icon" title="${tooltip}">üêå</span>`;
                                            }
                                            if (pestIcons.flying) {
                                                const translatedPests = pestsByCategory.flying.map(p => this.t(`pest.${p}`)).join(', ');
                                                const tooltip = this.t('tooltip.flying') + ': ' + translatedPests;
                                                iconsHTML += `<span class="pest-icon" title="${tooltip}">ü¶ü</span>`;
                                            }
                                            if (pestIcons.larvae) {
                                                const translatedPests = pestsByCategory.larvae.map(p => this.t(`pest.${p}`)).join(', ');
                                                const tooltip = this.t('tooltip.larvae') + ': ' + translatedPests;
                                                iconsHTML += `<span class="pest-icon" title="${tooltip}">üêõ</span>`;
                                            }
                                            if (pestIcons.beetles) {
                                                const translatedPests = pestsByCategory.beetles.map(p => this.t(`pest.${p}`)).join(', ');
                                                const tooltip = this.t('tooltip.beetles') + ': ' + translatedPests;
                                                iconsHTML += `<span class="pest-icon" title="${tooltip}">ü™≤</span>`;
                                            }
                                            
                                            return iconsHTML;
                                        })()}
                                    </div>
                                    ${goodCompanions.length > 0 ? `
                                        <div class="companions-list">
                                            ${goodCompanions.map(id => {
                                                const c = this.garden.vegetables.get(id);
                                                if (!c) return '';
                                                // Build tooltip explaining why it's a good companion
                                                const reasons = [];
                                                if (c.isCompatibleWith(veg.id) === 1) reasons.push(this.t('tooltip.traditionalCompanion'));
                                                if (c.protectsPlant(veg)) {
                                                    const pests = c.protectsAgainst.filter(p => veg.susceptibleTo.includes(p));
                                                    const translatedPests = pests.map(p => this.t(`pest.${p}`)).join(', ');
                                                    reasons.push(this.t('tooltip.protectsFrom') + ': ' + translatedPests);
                                                }
                                                const tooltip = reasons.join(' ‚Ä¢ ');
                                                return `<span class="companion-tag companion-good" title="${tooltip}">‚úì ${c.getName(this.currentLanguage)}</span>`;
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                    ${badCompanions.length > 0 ? `
                                        <div class="companions-list">
                                            ${badCompanions.map(id => {
                                                const c = this.garden.vegetables.get(id);
                                                if (!c) return '';
                                                const tooltip = this.t('tooltip.incompatible');
                                                return `<span class="companion-tag companion-bad" title="${tooltip}">‚úó ${c.getName(this.currentLanguage)}</span>`;
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                    ${protectedPlants.length > 0 ? `
                                        <div class="companions-list">
                                            ${protectedPlants.map(other => {
                                                const pests = veg.protectsAgainst.filter(p => other.susceptibleTo.includes(p));
                                                const translatedPests = pests.map(p => this.t(`pest.${p}`)).join(', ');
                                                const tooltip = this.t('tooltip.protectsFrom') + ': ' + translatedPests;
                                                return `<span class="companion-tag companion-protection" title="${tooltip}">üõ°Ô∏è ${other.getName(this.currentLanguage)}</span>`;
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                    ${sharedPestPlants.length > 0 ? `
                                        <div class="companions-list">
                                            ${sharedPestPlants.map(other => {
                                                const sharedPests = veg.sharesVulnerabilitiesWith(other);
                                                const pestNames = sharedPests.map(p => this.t(`pest.${p}`)).join(', ');
                                                return `<span class="companion-tag companion-warning" title="${pestNames}">ü™≥ ${other.getName(this.currentLanguage)}</span>`;
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('');
                    }
                    
                    let prevYearInfo = '';
                    if (prevPlantings.length > 0) {
                        prevYearInfo = `
                            <div style="font-size: 0.8rem; color: var(--soil-medium); margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--sage);">
                                ${this.t('bed.previous')} (${this.currentYear - 1}): ${prevPlantings.map(v => v.getName(this.currentLanguage)).join(', ')}
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="bed">
                            <div class="bed-header" onclick="app.openBedModal(${bed.id})" style="cursor: pointer;">
                                <div class="bed-name">${bed.getName(this.currentLanguage)}</div>
                                <div class="bed-actions">
                                    <button onclick="event.stopPropagation(); app.removeBed(${bed.id})" title="Remove bed">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div class="bed-content">
                                ${content}
                                ${prevYearInfo}
                            </div>
                        </div>
                    `;
                }).join('');
                
                this.renderWishlist();
            },
            
            // ===== TAB SYSTEM =====
            switchTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                    tab.style.display = 'none';
                });
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                
                const selectedTab = document.getElementById(`tab-${tabName}`);
                if (selectedTab) {
                    selectedTab.classList.add('active');
                    selectedTab.style.display = (tabName === 'garden') ? 'contents' : 'block';
                }
                document.querySelector(`.tab-btn[onclick*="${tabName}"]`)?.classList.add('active');
                
                // Initialize optimizer only on first visit
                if (tabName === 'optimizer' && !this.optimizer.initialized) {
                    this.initOptimizer();
                    this.optimizer.initialized = true;
                }
            },
            
            // ===== OPTIMIZER FUNCTIONS =====
            initOptimizer() {
                this.renderPlantSelector();
                document.getElementById('plantSearch').addEventListener('input', (e) => {
                    this.filterPlantSelector(e.target.value);
                });
            },
            
            renderPlantSelector() {
                const container = document.getElementById('plantSelector');
                const veggies = Array.from(this.garden.vegetables.values())
                    .sort((a, b) => a.getName(this.currentLanguage).localeCompare(b.getName(this.currentLanguage)));
                
                container.innerHTML = veggies.map(veg => {
                    const checked = this.optimizer.selectedPlants.includes(veg.id);
                    return `<label class="plant-checkbox ${checked ? 'checked' : ''}" data-plant="${veg.id}">
                        <input type="checkbox" ${checked ? 'checked' : ''} onchange="app.togglePlant('${veg.id}')">
                        <span>${veg.getName(this.currentLanguage)}</span>
                    </label>`;
                }).join('');
                this.updateSelectedCount();
            },
            
            filterPlantSelector(query) {
                document.querySelectorAll('.plant-checkbox').forEach(label => {
                    label.style.display = label.textContent.toLowerCase().includes(query.toLowerCase()) ? 'flex' : 'none';
                });
            },
            
            togglePlant(plantId) {
                const index = this.optimizer.selectedPlants.indexOf(plantId);
                if (index > -1) {
                    this.optimizer.selectedPlants.splice(index, 1);
                } else {
                    this.optimizer.selectedPlants.push(plantId);
                }
                document.querySelector(`.plant-checkbox[data-plant="${plantId}"]`)?.classList.toggle('checked');
                this.updateSelectedCount();
            },
            
            updateSelectedCount() {
                document.getElementById('selectedCount').textContent = this.optimizer.selectedPlants.length;
            },
            
            setOptimizerMode(mode) {
                this.optimizer.mode = mode;
                document.getElementById('mode-fresh').classList.toggle('selected', mode === 'fresh');
                document.getElementById('mode-fit').classList.toggle('selected', mode === 'fit');
            },
            
            runOptimizer() {
                if (this.optimizer.selectedPlants.length < 3) {
                    alert(this.t('optimizer.noSelection'));
                    return;
                }
                
                this.optimizer.maxPlantsPerBed = parseInt(document.getElementById('maxPlantsPerBed').value);
                const numBedsValue = document.getElementById('numBeds').value;
                this.optimizer.numBeds = numBedsValue === 'auto' ? null : parseInt(numBedsValue);
                
                const result = this.optimizeLayout();
                this.displayOptimizerResults(result);
            }
        };
        
        // ===== OPTIMIZATION ALGORITHM =====
        app.optimizeLayout = function() {
            const plants = this.optimizer.selectedPlants.map(id => this.garden.vegetables.get(id));
            const mode = this.optimizer.mode;
            const maxPerBed = this.optimizer.maxPlantsPerBed;
            
            // Calculate numBeds
            let numBeds;
            if (this.optimizer.numBeds === null || this.optimizer.numBeds === 'auto') {
                // Auto mode: calculate based on plants and maxPerBed
                numBeds = Math.ceil(plants.length / maxPerBed);
            } else {
                // Manual mode: use specified number
                numBeds = this.optimizer.numBeds;
            }
            
            // In Fit mode, ensure we have at least as many beds as currently exist
            if (mode === 'fit') {
                numBeds = Math.max(this.garden.beds.size, numBeds);
            }
            
            const forbidden = [];
            if (mode === 'fit') {
                const prevYear = this.currentYear - 1;
                this.garden.beds.forEach(bed => {
                    this.garden.getPlantingsForBed(bed.id, prevYear).forEach(plant => {
                        forbidden.push({ bedIndex: bed.id - 1, family: plant.family });
                    });
                });
            }
            
            let bestLayout = null;
            let bestScore = -Infinity;
            let bestUnplaced = [];
            
            for (let i = 0; i < 50; i++) {
                const shuffled = [...plants].sort(() => Math.random() - 0.5);
                const result = this.greedyPlacement(shuffled, numBeds, maxPerBed, forbidden);
                const optimized = this.localOptimization(result.beds);
                const score = this.evaluateLayout(optimized, forbidden);
                
                if (score > bestScore || (score === bestScore && result.unplaced.length < bestUnplaced.length)) {
                    bestScore = score;
                    bestLayout = optimized;
                    bestUnplaced = result.unplaced;
                }
            }
            
            return { beds: bestLayout, score: bestScore, numBeds, unplaced: bestUnplaced };
        };
        
        app.greedyPlacement = function(plants, numBeds, maxPerBed, forbidden) {
            const beds = Array.from({ length: numBeds }, () => []);
            const unplaced = [];
            
            plants.forEach(plant => {
                let bestBed = -1;
                let bestScore = -Infinity;
                
                for (let i = 0; i < numBeds; i++) {
                    if (beds[i].length >= maxPerBed) continue;
                    
                    const isForbidden = forbidden.some(f => f.bedIndex === i && f.family === plant.family);
                    if (isForbidden) continue;
                    
                    beds[i].push(plant);
                    const score = this.evaluateBed(beds[i]);
                    beds[i].pop();
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestBed = i;
                    }
                }
                
                if (bestBed >= 0) {
                    beds[bestBed].push(plant);
                } else {
                    unplaced.push(plant);
                }
            });
            
            return { beds, unplaced };
        };
        
        app.localOptimization = function(beds) {
            let improved = true;
            let iterations = 0;
            
            while (improved && iterations < 20) {
                improved = false;
                iterations++;
                
                for (let i = 0; i < beds.length; i++) {
                    for (let j = i + 1; j < beds.length; j++) {
                        for (let pi = 0; pi < beds[i].length; pi++) {
                            for (let pj = 0; pj < beds[j].length; pj++) {
                                const currentScore = this.evaluateBed(beds[i]) + this.evaluateBed(beds[j]);
                                
                                [beds[i][pi], beds[j][pj]] = [beds[j][pj], beds[i][pi]];
                                const newScore = this.evaluateBed(beds[i]) + this.evaluateBed(beds[j]);
                                
                                if (newScore > currentScore) {
                                    improved = true;
                                } else {
                                    [beds[i][pi], beds[j][pj]] = [beds[j][pj], beds[i][pi]];
                                }
                            }
                        }
                    }
                }
            }
            
            return beds;
        };
        
        app.evaluateBed = function(plants) {
            let score = 0;
            
            for (let i = 0; i < plants.length; i++) {
                for (let j = i + 1; j < plants.length; j++) {
                    const p1 = plants[i];
                    const p2 = plants[j];
                    
                    const compat = p1.isCompatibleWith(p2.id);
                    if (compat === 1) score += 1;
                    if (compat === -1) score -= 50;
                    
                    if (p2.protectsPlant(p1)) score += 20;
                    if (p1.protectsPlant(p2)) score += 20;
                    
                    const shared = p1.sharesVulnerabilitiesWith(p2);
                    score -= shared.length * 15;
                }
            }
            
            const high = plants.filter(p => p.nutrition === 'high').length;
            const low = plants.filter(p => p.nutrition === 'low').length;
            if (high > 0 && low > 0) score += 5;
            if (high === plants.length && plants.length > 2) score -= 10;
            
            return score;
        };
        
        app.evaluateLayout = function(beds, forbidden) {
            let score = 0;
            beds.forEach((bed, idx) => {
                score += this.evaluateBed(bed);
                
                bed.forEach(plant => {
                    const isForbidden = forbidden.some(f => f.bedIndex === idx && f.family === plant.family);
                    if (isForbidden) score -= 30;
                });
            });
            return score;
        };
        
        app.displayOptimizerResults = function(result) {
            const resultsDiv = document.getElementById('optimizerResults');
            const mode = this.optimizer.mode;
            
            const scorePercent = Math.max(0, Math.min(100, 50 + result.score));
            let scoreLabel = this.t('optimizer.poor');
            if (scorePercent >= 80) scoreLabel = this.t('optimizer.excellent');
            else if (scorePercent >= 70) scoreLabel = this.t('optimizer.veryGood');
            else if (scorePercent >= 60) scoreLabel = this.t('optimizer.good');
            else if (scorePercent >= 50) scoreLabel = this.t('optimizer.fair');
            
            let html = `
                <div class="optimization-result">
                    <h3>${this.t('optimizer.results')}</h3>
                    <div class="result-score">
                        ${this.t('optimizer.score')} ${Math.round(scorePercent)}/100 (${scoreLabel})
                    </div>
            `;
            
            result.beds.forEach((bed, idx) => {
                const bedNum = idx + 1;
                const bedName = `${this.t('optimizer.bed')} ${bedNum}`;
                
                let wasPlants = '';
                if (mode === 'fit' && this.garden.beds.has(bedNum)) {
                    const prevPlants = this.garden.getPlantingsForBed(bedNum, this.currentYear);
                    wasPlants = prevPlants.map(p => p.getName(this.currentLanguage)).join(', ') || this.t('bed.empty');
                }
                
                const nowPlants = bed.map(p => p.getName(this.currentLanguage)).join(', ');
                
                const reasons = [];
                for (let i = 0; i < bed.length; i++) {
                    for (let j = i + 1; j < bed.length; j++) {
                        if (bed[i].isCompatibleWith(bed[j].id) === 1) {
                            reasons.push(`‚úì ${bed[i].getName(this.currentLanguage)} + ${bed[j].getName(this.currentLanguage)}`);
                        }
                        if (bed[j].protectsPlant(bed[i])) {
                            reasons.push(`üõ°Ô∏è ${bed[j].getName(this.currentLanguage)} protects ${bed[i].getName(this.currentLanguage)}`);
                        }
                    }
                }
                
                html += `
                    <div class="proposed-bed">
                        <strong>${bedName}</strong>
                        ${mode === 'fit' ? `
                            <div class="bed-comparison">
                                <div><small>${this.t('optimizer.was')}</small> ${wasPlants}</div>
                                <div class="bed-comparison-arrow">‚Üí</div>
                                <div><small>${this.t('optimizer.now')}</small> ${nowPlants}</div>
                            </div>
                        ` : `
                            <div style="margin-top: 0.5rem;">${nowPlants}</div>
                        `}
                        ${reasons.length > 0 ? `
                            <div class="bed-reasons">
                                <strong>${this.t('optimizer.reasons')}</strong>
                                <ul>${reasons.slice(0, 3).map(r => `<li>${r}</li>`).join('')}</ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            // Show unplaced plants if any
            if (result.unplaced && result.unplaced.length > 0) {
                html += `
                    <div class="proposed-bed" style="background: rgba(193, 105, 79, 0.1); border-left: 4px solid var(--terracotta);">
                        <strong>‚ö†Ô∏è ${this.t('optimizer.unplaced')}</strong>
                        <div style="margin-top: 0.5rem; color: var(--terracotta);">
                            <strong>${this.t('optimizer.unplacedPlants')}:</strong> ${result.unplaced.map(p => p.getName(this.currentLanguage)).join(', ')}
                        </div>
                    </div>
                `;
            }
            
            // Show improvement suggestions if score is poor or plants unplaced
            if (scorePercent < 60 || (result.unplaced && result.unplaced.length > 0)) {
                const suggestions = [];
                
                if (result.unplaced && result.unplaced.length > 0) {
                    const totalPlants = this.optimizer.selectedPlants.length;
                    const capacity = result.numBeds * this.optimizer.maxPlantsPerBed;
                    if (totalPlants > capacity) {
                        const neededBeds = Math.ceil(totalPlants / this.optimizer.maxPlantsPerBed);
                        suggestions.push(this.t('optimizer.improveBeds') + ` (${this.t('optimizer.numBeds')}: ${neededBeds})`);
                        suggestions.push(this.t('optimizer.improvePlantsPerBed'));
                        suggestions.push(this.t('optimizer.improveRemovePlants'));
                    }
                }
                
                if (scorePercent < 60 && this.optimizer.mode === 'fit') {
                    suggestions.push(this.t('optimizer.improveRotation'));
                }
                
                if (suggestions.length > 0) {
                    html += `
                        <div class="proposed-bed" style="background: rgba(232, 184, 77, 0.1); border-left: 4px solid var(--sun-yellow);">
                            <strong>${this.t('optimizer.improvements')}</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem;">
                                ${suggestions.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            }
            
            html += `
                    <div style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem;">
                        <button class="btn btn-primary" onclick="app.applyOptimizedLayout()" style="width: 100%;">
                            ${this.t('optimizer.apply')}
                        </button>
                        <button class="btn btn-secondary" onclick="app.runOptimizer()" style="width: 100%;">
                            ${this.t('optimizer.newCalc')}
                        </button>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
            
            this.optimizer.proposedLayout = result.beds;
            this.optimizer.score = result.score;
        };
        
        app.applyOptimizedLayout = function() {
            if (!confirm(this.t('optimizer.applyConfirm'))) return;
            
            // Clear current year plantings
            this.garden.plantings = this.garden.plantings.filter(p => p.year !== this.currentYear);
            
            // Clear all beds
            this.garden.beds.clear();
            
            // Create new beds from proposed layout
            this.optimizer.proposedLayout.forEach((bed, idx) => {
                const newBed = this.garden.addBed();
                bed.forEach(plant => {
                    this.garden.assignToBed(plant.id, newBed.id, this.currentYear);
                });
            });
            
            // Save to localStorage
            this.save();
            
            // Switch to Manual Planning tab FIRST
            this.switchTab('garden');
            
            // Then render the garden
            this.render();
            
            // Hide optimizer results
            document.getElementById('optimizerResults').style.display = 'none';
            
            // Show success message
            setTimeout(() => {
                alert(this.t('optimizer.applied'));
            }, 100);
        };
        
        // Initialize app
        app.init();
        
        // Touch-friendly tooltips
        document.addEventListener('click', (e) => {
            const target = e.target;
            
            // Check if clicked on pest-icon or companion-tag
            if (target.classList.contains('pest-icon') || target.classList.contains('companion-tag')) {
                // Remove all other tooltips
                document.querySelectorAll('.show-tooltip').forEach(el => {
                    if (el !== target) el.classList.remove('show-tooltip');
                });
                
                // Toggle tooltip on clicked element
                if (target.classList.contains('show-tooltip')) {
                    target.classList.remove('show-tooltip');
                } else {
                    // Copy title to data-tooltip for CSS
                    if (target.title) {
                        target.setAttribute('data-tooltip', target.title);
                        target.removeAttribute('title'); // Remove to prevent browser tooltip
                    }
                    target.classList.add('show-tooltip');
                    
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        target.classList.remove('show-tooltip');
                    }, 5000);
                }
                
                // CRITICAL: Prevent event from bubbling to parent bed onclick
                e.stopPropagation();
                e.preventDefault();
            } else {
                // Click anywhere else closes all tooltips
                document.querySelectorAll('.show-tooltip').forEach(el => {
                    el.classList.remove('show-tooltip');
                });
            }
        });
        
        // ============================================
        // PWA SERVICE WORKER & INSTALLATION
        // ============================================
        
        // Service Worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'beet-anything-v1';
                    const urlsToCache = ['./', 'index.html'];
                    
                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => response || fetch(event.request))
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker error:', err));
            });
        }
        
        // PWA Installation
        let deferredPrompt;
        window.deferredPrompt = null;
        
        const installButton = document.createElement('button');
        installButton.id = 'floatingInstallButton';
        installButton.className = 'btn btn-primary';
        installButton.innerHTML = 'üì± Install as App';
        installButton.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
        document.body.appendChild(installButton);
        
        const headerInstallButton = document.getElementById('headerInstallButton');
        
        // Check if already installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('App is already running as PWA');
        } else {
            // Show header button always (for manual installation)
            if (headerInstallButton) {
                headerInstallButton.style.display = 'inline-block';
            }
        }
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            window.deferredPrompt = e;
            
            // Show both buttons
            installButton.style.display = 'block';
            if (headerInstallButton) {
                headerInstallButton.style.display = 'inline-block';
            }
        });
        
        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) {
                app.showInstallationInstructions();
                return;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('App was installed');
            }
            
            deferredPrompt = null;
            window.deferredPrompt = null;
            installButton.style.display = 'none';
            if (headerInstallButton) {
                headerInstallButton.style.display = 'none';
            }
        });
        
        // Hide buttons after installation
        window.addEventListener('appinstalled', () => {
            installButton.style.display = 'none';
            if (headerInstallButton) {
                headerInstallButton.style.display = 'none';
            }
            console.log('Beet Anything was installed as an app!');
        });
    </script>
    
    <!-- Footer -->
    <footer>
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <button class="btn btn-secondary btn-small" onclick="app.clearAllData()" 
                        style="background: transparent; border: 1px solid var(--soil-medium); color: var(--soil-medium); font-size: 0.8rem;">
                    <span data-i18n="data.clearAll">üóëÔ∏è Clear All Data</span>
                </button>
            </div>
            <div style="text-align: right; flex: 1;">
                <p>
                    <a href="https://github.com/schatzl/beet-anything" target="_blank" rel="noopener noreferrer">
                        <span class="github-icon">üì¶</span>
                        <span data-i18n="footer.viewOnGitHub">View on GitHub</span>
                    </a>
                </p>
                <p style="font-size: 0.85rem; margin-top: 1rem; color: var(--soil-medium);">
                    <span data-i18n="footer.madeWith">Made with</span> üå± <span data-i18n="footer.forGardeners">for gardeners</span>
                </p>
            </div>
        </div>
    </footer>
</body>
</html>
